<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&S: CR√ìNICAS ANTIGUAS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* === VARIABLES DE COLOR OSR === */
        :root {
            --bg-paper: #f3e5ce; --ink-main: #1a1a1a; --ink-red: #8b0000; --ink-accent: #4a3b2a;
            --font-title: 'IM Fell English SC', serif; --font-body: 'Crimson Text', serif; --font-mono: 'Courier Prime', monospace;
        }

        /* === BASIC SETUP === */
        body {
            font-family: var(--font-body); background-color: var(--bg-paper); color: var(--ink-main);
            padding: 25px; background-image: radial-gradient(#d6c6a8 1px, transparent 1px); background-size: 20px 20px;
        }
        .container { max-width: 1100px; margin: auto; display: grid; grid-template-columns: 300px 1fr; gap: 30px; }

        h1 { font-family: var(--font-title); font-size: 2.5em; text-align: center; border-bottom: 3px double var(--ink-main); margin-bottom: 30px; }
        h2 { font-family: var(--font-title); color: var(--ink-red); font-size: 1.5em; border-bottom: 1px solid var(--ink-accent); margin-top: 0; }
        h3 { font-family: var(--font-title); font-size: 1.1em; text-decoration: underline; margin-bottom: 5px; }

        .sidebar, .section { background: #fffef8; border: 2px solid var(--ink-main); padding: 20px; margin-bottom: 25px; box-shadow: 5px 5px 0px rgba(0,0,0,0.1); position: relative; }
        .section::before { content: "‚ùñ"; position: absolute; top: -14px; left: 50%; transform: translateX(-50%); background: #fffef8; padding: 0 10px; font-size: 1.2em; }

        label { font-family: var(--font-title); color: var(--ink-accent); display: block; margin-top: 10px; }
        input, select { background: transparent; border: none; border-bottom: 2px dashed #999; font-family: var(--font-mono); font-weight: bold; color: var(--ink-main); padding: 5px; width: 100%; font-size: 1.1em; }
        input:focus, select:focus { outline: none; border-bottom: 2px solid var(--ink-red); background: rgba(139, 0, 0, 0.05); }
        input[type="number"] { text-align: center; font-size: 1.4em; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        
        .skill-area { border: 1px solid var(--ink-main); padding: 10px; background: #fdfdfd; max-height: 200px; overflow-y: auto; }
        .skill-opt { cursor: pointer; display: block; margin-bottom: 4px; }
        .skill-opt:hover { background-color: #eee; }
        .grade-1 { background: var(--ink-main); color: #fff; }

        .res-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .big-stat { border: 4px solid var(--ink-main); text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 50% 50% 0 0; background: #fff; }
        .big-stat h3 { margin: 0; font-size: 3.5em; color: var(--ink-red); font-family: var(--font-title); }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #ccc; padding: 5px 0; font-size: 1.2em; }
        .stat-val { font-family: var(--font-mono); font-weight: bold; }

        .portrait-frame { width: 180px; height: 270px; margin: 0 auto 20px auto; border: 4px double var(--ink-main); border-radius: 4px; overflow: hidden; background: #e8dcc5; cursor: pointer; position: relative; box-shadow: 3px 3px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .portrait-frame:hover { transform: scale(1.02); border-color: var(--ink-red); }
        .portrait-frame img { width: 100%; height: 100%; object-fit: cover; }
        .portrait-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; font-size: 0.7em; text-align: center; padding: 5px; font-family: var(--font-mono); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .portrait-frame:hover .portrait-label { opacity: 1; }

        .action-bar { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
        .btn { background: #fff; border: 2px solid var(--ink-main); color: var(--ink-main); font-family: var(--font-title); font-size: 1.2em; padding: 10px; width: 100%; cursor: pointer; box-shadow: 4px 4px 0px var(--ink-main); text-transform: uppercase; }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--ink-main); }
        .btn:hover { background: var(--ink-red); color: #fff; border-color: var(--ink-red); }
        .btn-clear { background: #eee; border: 1px dashed var(--ink-main); font-size: 1em; margin-bottom: 20px;}

        .bonus-desc { font-family: var(--font-body); font-style: italic; color: #555; font-size: 0.95em; margin-top: 5px; }
        #stats_final_display { font-family: var(--font-mono); background: var(--ink-main); color: #ffffff !important; padding: 8px; margin-top: 15px; font-size: 1.1em; border: 2px solid var(--ink-main); }

        input[type="radio"], input[type="checkbox"] { appearance: none; width: 16px; height: 16px; border: 2px solid var(--ink-main); cursor: pointer; display: inline-block; vertical-align: middle; margin-right: 5px; }
        input[type="radio"] { border-radius: 50%; }
        input[type="radio"]:checked, input[type="checkbox"]:checked { background-color: var(--ink-red); border-color: var(--ink-red); box-shadow: inset 0 0 0 3px var(--bg-paper); }

        .sidebar { position: sticky; top: 20px; height: fit-content; }
        hr { border: 0; border-top: 2px solid var(--ink-main); margin: 15px 0; height: 3px; border-bottom: 1px solid var(--ink-main); }
        .warn-text { color: var(--ink-red); font-family: var(--font-title); font-weight: bold; text-align: center; }

        dialog.modal-osr { background: var(--bg-paper); color: var(--ink-main); border: 4px double var(--ink-main); width: 90%; max-width: 500px; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.7); }
        .modal-header { background: var(--ink-main); color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 400px; overflow-y: auto; }
        .char-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--ink-main); padding: 10px 0; }
        .btn-mini { padding: 5px 10px; margin-left: 5px; cursor: pointer; border: 1px solid var(--ink-main); }
        .btn-load { background: var(--ink-main); color: #fff; }
        .btn-del { background: transparent; color: var(--ink-red); border-color: var(--ink-red); }
    </style>
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <input type="file" id="img_input" accept="image/*" style="display:none" onchange="app.loadImage(this)">
        <div class="portrait-frame" onclick="document.getElementById('img_input').click()">
            <img id="char_img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a3b2a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Retrato">
            <span class="portrait-label">CAMBIAR RETRATO</span>
        </div>

        <div style="margin-bottom: 20px;">
            <label>Nombre del Aventurero</label>
            <input type="text" id="char_name" placeholder="Escribe aqu√≠..." style="font-family: 'IM Fell English SC'; font-size: 1.3em;">
        </div>
        
        <div class="action-bar">
            <button class="btn" onclick="app.randomize()">Aleatorizar</button>
            <button class="btn" onclick="app.saveChar()">Guardar</button>
            <button class="btn" onclick="app.openLoadMenu()">Cargar</button>
        </div>
        <button class="btn btn-clear" onclick="app.clear()">LIMPIAR HOJA</button>

        <div class="big-stat">
            <h3 id="res_pv">0</h3>
            <span style="font-family: var(--font-title); font-weight: bold;">PUNTOS DE VIDA</span>
        </div>
        
        <div class="stat-row"><span>Umbral de Carne</span><span class="stat-val" id="res_carne">0</span></div>
        <div class="stat-row"><span>Clase de Armadura</span><span class="stat-val" id="res_ca">10</span></div>
        <div class="stat-row"><span>Iniciativa</span><span class="stat-val" id="res_ini">+0</span></div>
        <div class="stat-row" style="color:#6a0dad"><span>Ataque M√°gico</span><span class="stat-val" id="res_atq_mag">+2</span></div>
        <hr>
        <div class="stat-row" style="color:var(--ink-red)"><span>Adrenalina</span><span class="stat-val" id="res_adr">0</span></div>
        <div class="stat-row" style="color:#003366"><span>Ingenio</span><span class="stat-val" id="res_ing">0</span></div>
        <div class="stat-row"><span>Filo Activo</span><span class="stat-val" id="res_filo_val">F√≠sico</span></div>
        <hr>
        <div class="stat-row"><span>Carga (Slots)</span><span class="stat-val" id="res_carga">0 / 0</span></div>
        <p id="carga_warn" class="warn-text" style="display:none;">¬°EST√ÅS SOBRECARGADO!</p>
        
        <button id="btn-install" class="btn" style="display:none; color:var(--ink-red); border-color:var(--ink-red); margin-top:10px;">üì≤ INSTALAR APP</button>
    </aside>

    <main class="main-content">
        <div class="section">
            <h2>I. Los Seis Pilares (8-18)</h2>
            <div class="grid-4">
                <div><label>FUE</label><input type="number" id="base_FUE" value="8" min="3" max="18" onchange="app.calc()"></div>
                <div><label>DES</label><input type="number" id="base_DES" value="8" min="3" max="18" onchange="app.calc()"></div>
                <div><label>CON</label><input type="number" id="base_CON" value="8" min="3" max="18" onchange="app.calc()"></div>
                <div><label>INT</label><input type="number" id="base_INT" value="8" min="3" max="18" onchange="app.calc()"></div>
                <div><label>SAB</label><input type="number" id="base_SAB" value="8" min="3" max="18" onchange="app.calc()"></div>
                <div><label>CAR</label><input type="number" id="base_CAR" value="8" min="3" max="18" onchange="app.calc()"></div>
            </div>
            <div id="stats_final_display"></div>
        </div>

        <div class="section">
            <h2>II. Identidad y Origen</h2>
            <div class="grid-2">
                <div>
                    <label>Linaje (Raza)</label>
                    <select id="sel_desc" onchange="app.updateOptions()"></select>
                    <div id="desc_info" class="bonus-desc"></div>
                </div>
                <div>
                    <label>Arquetipo (Clase)</label>
                    <select id="sel_arq" onchange="app.updateOptions()"></select>
                    <div id="arq_info" class="bonus-desc"></div>
                    
                    <label style="margin-top:10px; font-size:0.9em;">Selecci√≥n de Filo (Edge)</label>
                    <select id="sel_filo" onchange="app.calc()"></select>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <label>Trasfondo</label>
                <select id="sel_bg" onchange="app.updateOptions()"></select>
                <div id="bg_info" class="bonus-desc"></div>
            </div>
        </div>

        <div class="section">
            <h2>III. Tiradas de Salvaci√≥n (Bono +2)</h2>
            <div class="grid-2">
                <div>
                    <h3>Comunes</h3>
                    <label class="skill-opt"><input type="radio" name="save_common" value="DES" onchange="app.calc()"> Destreza (DES)</label>
                    <label class="skill-opt"><input type="radio" name="save_common" value="CON" onchange="app.calc()"> Constituci√≥n (CON)</label>
                    <label class="skill-opt"><input type="radio" name="save_common" value="SAB" onchange="app.calc()"> Sabidur√≠a (SAB)</label>
                </div>
                <div>
                    <h3>Poco Comunes</h3>
                    <label class="skill-opt"><input type="radio" name="save_uncommon" value="FUE" onchange="app.calc()"> Fuerza (FUE)</label>
                    <label class="skill-opt"><input type="radio" name="save_uncommon" value="INT" onchange="app.calc()"> Intelecto (INT)</label>
                    <label class="skill-opt"><input type="radio" name="save_uncommon" value="CAR" onchange="app.calc()"> Carisma (CAR)</label>
                </div>
            </div>
            <div id="saves_display" style="margin-top: 15px; border-top: 2px double var(--ink-main); padding-top: 10px; display: grid; grid-template-columns: repeat(6, 1fr); text-align: center; font-family: var(--font-mono); font-weight: bold; font-size: 1.1em;"></div>
        </div>

        <div class="section">
            <h2>IV. Habilidades y Maestr√≠a</h2>
            <div class="grid-2">
                <div>
                    <h3>Por Arquetipo (Elige <span id="limit_arq">2</span>)</h3>
                    <div id="skills_arq" class="skill-area"></div>
                </div>
                <div>
                    <h3>Por Trasfondo (Elige 2)</h3>
                    <div id="skills_bg" class="skill-area"></div>
                </div>
            </div>
            <div style="margin-top: 15px; border-top: 1px solid var(--ink-main); padding-top: 10px;">
                <label>MAESTR√çAS FINALES</label>
                <div id="final_skills_list"></div>
            </div>
        </div>

        <div class="section">
            <h2>V. Talentos (Elige 3)</h2>
            <div id="talents_container" class="grid-2"></div>
            <div style="text-align:right; margin-top:5px; font-family:var(--font-mono);">
                Seleccionados: <span id="talent_count">0</span>/3
            </div>
        </div>

        <div class="section">
            <h2>VI. Equipo de Combate</h2>
            <div class="grid-2">
                <div>
                    <label>Armadura</label>
                    <select id="sel_armor" onchange="app.calc()"></select>
                    <div id="armor_info" class="bonus-desc"></div>
                </div>
                <div>
                    <label>Escudo & Extras</label>
                    <select id="sel_shield" onchange="app.calc()"></select>
                    <div style="margin-top:10px;">
                        <label class="skill-opt" style="font-size:0.9em; color:var(--ink-accent);">
                            <input type="checkbox" id="chk_magic_ac" onchange="app.calc()"> Bono M√°gico (+1 CA)
                        </label>
                    </div>
                </div>
            </div>
            <label style="margin-top:10px;">Arma Principal</label>
            <select id="sel_weapon" onchange="app.calc()"></select>
            <div style="margin-top: 15px; text-align: center; border: 2px solid var(--ink-main); padding: 10px;">
                <label style="margin:0;">ESTAD√çSTICAS DE COMBATE</label>
                <p id="weapon_info" style="font-size: 1.3em; font-family: var(--font-mono); margin: 5px 0 0 0; color: var(--ink-main);"></p>
                <div id="prof_alert" style="color:var(--ink-red); font-size:0.8em; margin-top:5px; font-weight:bold;"></div>
            </div>
        </div>
    </main>
</div>

<dialog id="char_manager" class="modal-osr">
    <div class="modal-header">
        <h2>üìú Libro de H√©roes</h2>
        <button class="btn-close" onclick="document.getElementById('char_manager').close()">‚úñ</button>
    </div>
    <div id="char_list" class="modal-body"></div>
</dialog>

<script>
// --- BASE DE DATOS ACTUALIZADA ---
const DB = {
    descriptors: {
        "humano": { name: "Humano", bonus: "+1 a Dos", mods:{}, grant: [], txt: "Vers√°til, Ambici√≥n." },
        "enano": { name: "Enano", bonus: "+2 CON, +1 FUE", mods:{CON:2, FUE:1}, grant: [], txt: "Robusto, Visi√≥n Oscuridad." },
        "elfo": { name: "Elfo", bonus: "+2 DES, +1 SAB", mods:{DES:2, SAB:1}, grant: ["Proeza F√≠sica"], txt: "Inmune Encanto, Grado 1 Proeza F√≠sica." },
        "medio_elfo": { name: "Medio Elfo", bonus: "+1 a Dos", mods:{}, grant: ["Perspicacia", "Influencia"], txt: "Visi√≥n Oscuridad, Empat√≠a Experta." },
        "infernal": { name: "Infernal", bonus: "+2 CAR, +1 INT", mods:{CAR:2, INT:1}, grant: [], txt: "Resistencia Fuego, Visi√≥n Oscuridad." },
        "sintetico": { name: "Sint√©tico", bonus: "+2 CON", mods:{CON:2}, grant: [], txt: "Inmune Veneno, No duerme." },
        "aesir": { name: "Aesir", bonus: "+2 CAR, +1 SAB", mods:{CAR:2, SAB:1}, grant: [], txt: "Resistencia Radiante." },
        "mutante": { name: "Mutante", bonus: "+2 Elige, +1 CON", mods:{CON:1}, grant: [], txt: "Inmune T√≥xico, Rasgo Aberrante." },
        "medio_orco": { name: "Medio Orco", bonus: "+2 FUE, +1 CON", mods:{FUE:2, CON:1}, grant: [], txt: "Implacable (1 PV al caer)." },
        "draconido": { name: "Drac√≥nido", bonus: "+2 FUE, +1 CAR", mods:{FUE:2, CAR:1}, grant: [], txt: "Resistencia Elemental, Presencia." },
        "cambiante": { name: "Cambiante", bonus: "+2 FUE/DES, +1 CON", mods:{FUE:2, CON:1}, grant: ["Supervivencia"], txt: "Garras Naturales, Instinto." }
    },
    
    // Arquetipos con reglas de Filo y descripci√≥n
    archetypes: {
        "valor": { 
            name: "Audaz (Luchador)", pv: 8, adr: 6, ing: 2, ca: 1, limit: 2,
            skills: ["Proeza F√≠sica", "Intimidaci√≥n", "Percepci√≥n", "Supervivencia"], 
            edges: ["F√≠sico", "Mental"],
            txt: "Competencia Total. Ignora requisitos. +1 CA." 
        },
        "gracia": { 
            name: "Sutil (Experto)", pv: 6, adr: 4, ing: 4, ca: 0, limit: 2,
            skills: ["Sigilo", "Enga√±o", "Investigaci√≥n", "Percepci√≥n", "Proeza F√≠sica", "Tecnolog√≠a"], 
            edges: ["F√≠sico", "Mental", "Flexible"],
            txt: "Comp. Simple + Sutil. Ignora req en Sutiles." 
        },
        "espiritu": { 
            name: "Sagaz (Adepto)", pv: 4, adr: 0, ing: 10, ca: 0, limit: 4,
            skills: ["Arcano", "Historia", "Medicina", "Naturaleza", "Perspicacia", "Investigaci√≥n", "Religi√≥n"], 
            edges: ["Mental", "F√≠sico"],
            txt: "Comp. Simple solamente. Debe cumplir requisitos." 
        }
    },
    
    // Backgrounds (Sin cambios)
    backgrounds: {
        "soldado": { name: "Soldado", skills: ["Proeza F√≠sica", "Intimidaci√≥n", "Perspicacia", "Tecnolog√≠a", "Supervivencia", "Medicina"] },
        "picaro": { name: "P√≠caro", skills: ["Sigilo", "Enga√±o", "Influencia", "Conocimiento Calle", "Percepci√≥n", "Tecnolog√≠a"] },
        "acolito": { name: "Ac√≥lito", skills: ["Religi√≥n", "Perspicacia", "Influencia", "Medicina", "Historia", "Investigaci√≥n"] },
        "erudito": { name: "Erudito", skills: ["Arcano", "Historia", "Investigaci√≥n", "Naturaleza", "Tecnolog√≠a", "Medicina"] },
        "salvaje": { name: "Salvaje", skills: ["Supervivencia", "Percepci√≥n", "Naturaleza", "Sigilo", "Proeza F√≠sica", "Medicina"] },
        "artesano": { name: "Artesano", skills: ["Investigaci√≥n", "Artesan√≠a", "Influencia", "Tecnolog√≠a", "Historia", "Percepci√≥n"] },
        "forastero": { name: "Forastero", skills: ["Supervivencia", "Sigilo", "Enga√±o", "Perspicacia", "Conocimiento Calle", "Percepci√≥n"] },
        "noble": { name: "Noble", skills: ["Influencia", "Historia", "Enga√±o", "Perspicacia", "Religi√≥n", "Investigaci√≥n"] },
        "mercenario": { name: "Mercenario", skills: ["Intimidaci√≥n", "Percepci√≥n", "Supervivencia", "Enga√±o", "Proeza F√≠sica", "Influencia"] },
        "marinero": { name: "Marinero", skills: ["Proeza F√≠sica", "Percepci√≥n", "Supervivencia", "Enga√±o", "Tecnolog√≠a", "Naturaleza"] },
        "gladiador": { name: "Gladiador", skills: ["Intimidaci√≥n", "Proeza F√≠sica", "Influencia", "Percepci√≥n", "Enga√±o", "Supervivencia"] },
        "mercader": { name: "Mercader", skills: ["Influencia", "Investigaci√≥n", "Enga√±o", "Perspicacia", "Conocimiento Calle", "Historia"] },
        "superviviente": { name: "Superviviente", skills: ["Supervivencia", "Proeza F√≠sica", "Percepci√≥n", "Medicina", "Sigilo", "Naturaleza"] }
    },
    
    // Talentos (Sin cambios)
    talents: {
        "acero": [
            { name: "Lancero Marcial", desc: "Ataque oportunidad al entrar." },
            { name: "Maestro del Escudo", desc: "Reacci√≥n para golpear/bloquear." },
            { name: "Tirador Preciso", desc: "Ignora cobertura, gasta Adr para da√±o." },
            { name: "Duelista", desc: "Desventaja a enemigo o Riposte." },
            { name: "Escuela Combate", desc: "+1 CA o +2 Da√±o." }
        ],
        "adrenalina": [
            { name: "Furia Primal", desc: "+2 Da√±o, resiste miedo." },
            { name: "Defensa Natural", desc: "CA = 10+DES+CON (Sin armadura).", id:"def_nat" },
            { name: "Carga Demoledora", desc: "Derriba al moverte." },
            { name: "Resistente", desc: "Recupera max PV al descansar." }
        ],
        "astucia": [
            { name: "Ataque Furtivo", desc: "+1d6 da√±o con ventaja." },
            { name: "Marca de Cacer√≠a", desc: "Rastrear y +1d6 da√±o." },
            { name: "Mov. Silencioso", desc: "Sigilo vel normal." },
            { name: "Herramientas", desc: "Usar objeto acci√≥n gratis." }
        ],
        "fuente": [
            { name: "Despertar", desc: "+6 Ingenio, Trucos y Poderes.", id:"despertar" },
            { name: "Pacto", desc: "Beneficios de patr√≥n." },
            { name: "Canalizar", desc: "Gasta Ingenio para efectos." }
        ],
        "general": [
            { name: "Alerta", desc: "+5 Iniciativa.", id:"alerta" },
            { name: "Atleta", desc: "+1 FUE o DES.", id:"atleta" }
        ]
    },
    
    // Armas actualizadas con Categor√≠a, Propiedad y Requisitos
    weapons: {
        "desarmado": { name: "Desarmado", dmg: "1d4", stat: "FUE", slots: 0, cat: "simple", prop: "sutil", req: 0 },
        "daga": { name: "Daga", dmg: "1d4", stat: "FIN", slots: 1, cat: "simple", prop: "sutil", req: 0 },
        "baston": { name: "Bast√≥n", dmg: "1d6", stat: "FUE", slots: 1, cat: "simple", prop: "versatil", req: 0 },
        "martillo_l": { name: "Martillo Ligero", dmg: "1d6", stat: "FUE", slots: 1, cat: "simple", prop: "arrojadiza", req: 0 },
        "ballesta": { name: "Ballesta Ligera", dmg: "1d8", stat: "DES", slots: 2, cat: "simple", prop: "distancia", req: 0 },
        
        "espada_c": { name: "Espada Corta", dmg: "1d6", stat: "FIN", slots: 1, cat: "marcial", prop: "sutil", req: 0 },
        "espada_l": { name: "Espada Larga", dmg: "1d8", stat: "FUE", slots: 2, cat: "marcial", prop: "versatil", req: 10 },
        "hacha": { name: "Hacha Batalla", dmg: "1d8", stat: "FUE", slots: 2, cat: "marcial", prop: "versatil", req: 10 },
        "martillo_g": { name: "Martillo Guerra", dmg: "1d8/10", stat: "FUE", slots: 2, cat: "marcial", prop: "versatil", req: 10 },
        
        "espadon": { name: "Espad√≥n", dmg: "2d6", stat: "FUE", slots: 3, cat: "marcial", prop: "pesada", req: 13 },
        "gran_hacha": { name: "Gran Hacha", dmg: "1d12", stat: "FUE", slots: 3, cat: "marcial", prop: "pesada", req: 13 },
        "arco_c": { name: "Arco Corto", dmg: "1d6", stat: "DES", slots: 2, cat: "marcial", prop: "distancia", req: 0 },
        "arco_l": { name: "Arco Largo", dmg: "1d8", stat: "DES", slots: 3, cat: "marcial", prop: "distancia", req: 11 }
    },

    armors: {
        "none": { name: "Ropa (Sin Armadura)", ca: 10, type: "none", slots: 0 },
        "cuero": { name: "Cuero (Ligera)", ca: 11, type: "light", slots: 1 },
        "tachonado": { name: "Cuero Tachonado", ca: 12, type: "light", slots: 1 },
        "pieles": { name: "Pieles (Media)", ca: 12, type: "medium", slots: 2 },
        "coraza": { name: "Coraza (Media)", ca: 14, type: "medium", slots: 2 },
        "malla": { name: "Cota de Malla (P)", ca: 16, type: "heavy", slots: 3 },
        "placas": { name: "Placas (P)", ca: 18, type: "heavy", slots: 4 }
    },
    shields: {
        "none": { name: "Sin Escudo", bonus: 0, slots: 0 },
        "rodela": { name: "Rodela (+1 CA)", bonus: 1, slots: 0 },
        "escudo": { name: "Escudo (+2 CA)", bonus: 2, slots: 1 },
        "torre": { name: "Escudo Torre (+3 CA)", bonus: 3, slots: 2 }
    }
};

const app = {
    init: function() {
        this.fillSelect('sel_desc', DB.descriptors);
        this.fillSelect('sel_arq', DB.archetypes);
        this.fillSelect('sel_bg', DB.backgrounds);
        this.fillSelect('sel_armor', DB.armors);
        this.fillSelect('sel_weapon', DB.weapons);
        this.fillSelect('sel_shield', DB.shields);
        this.renderTalents();
        this.updateOptions(true);
    },
    
    fillSelect: function(id, data) {
        const s = document.getElementById(id);
        s.innerHTML = "";
        for(let k in data) {
            let o = document.createElement('option');
            o.value = k;
            o.innerText = data[k].name;
            s.appendChild(o);
        }
    },
    
    loadImage: function(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 500; const MAX_HEIGHT = 750;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                    else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    document.getElementById('char_img').src = canvas.toDataURL('image/jpeg', 0.7);
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    },

    updateOptions: function(resetCheckboxes = false) {
        const arqKey = document.getElementById('sel_arq').value;
        const bgKey = document.getElementById('sel_bg').value;
        const descKey = document.getElementById('sel_desc').value;

        // Info Textos
        document.getElementById('desc_info').innerText = DB.descriptors[descKey].bonus + ". " + DB.descriptors[descKey].txt;
        document.getElementById('arq_info').innerText = DB.archetypes[arqKey].txt;
        document.getElementById('bg_info').innerText = "Otorga 2 Habilidades y Kit.";

        // Actualizar Select de Filo (Edge) seg√∫n Arquetipo
        const filoSelect = document.getElementById('sel_filo');
        const availableEdges = DB.archetypes[arqKey].edges;
        
        // Guardar valor actual para intentar mantenerlo
        const currentEdge = filoSelect.value;
        filoSelect.innerHTML = "";
        availableEdges.forEach(edge => {
            let opt = document.createElement('option');
            opt.value = edge; opt.innerText = edge;
            filoSelect.appendChild(opt);
        });
        if(availableEdges.includes(currentEdge)) filoSelect.value = currentEdge;

        // Render Skills
        this.renderCheckboxes('skills_arq', 'chk_arq', DB.archetypes[arqKey].skills, DB.archetypes[arqKey].limit);
        this.renderCheckboxes('skills_bg', 'chk_bg', DB.backgrounds[bgKey].skills, 2);
        document.getElementById('limit_arq').innerText = DB.archetypes[arqKey].limit;
        
        this.calc();
    },

    renderCheckboxes: function(containerId, name, skills, limit) {
        const div = document.getElementById(containerId);
        div.innerHTML = "";
        skills.forEach(s => {
            const lbl = document.createElement('label');
            lbl.className = 'skill-opt';
            lbl.innerHTML = `<input type="checkbox" name="${name}" value="${s}" onchange="app.checkLimit('${name}', ${limit}); app.calc()"> ${s}`;
            div.appendChild(lbl);
        });
    },

    renderTalents: function() {
        const container = document.getElementById('talents_container');
        container.innerHTML = "";
        for (let cat in DB.talents) {
            let col = document.createElement('div');
            col.innerHTML = `<h3 style="margin:0 0 5px 0; color:var(--ink-accent); border:none; text-decoration:none; font-size:1em;">${cat.toUpperCase()}</h3>`;
            DB.talents[cat].forEach(t => {
                let lbl = document.createElement('label');
                lbl.className = 'skill-opt';
                let extraAttr = t.id ? `data-id="${t.id}"` : "";
                lbl.innerHTML = `<input type="checkbox" name="chk_talents" value="${t.name}" ${extraAttr} onchange="app.checkLimit('chk_talents', 3); app.calc()"> 
                                 <span style="font-weight:bold">${t.name}</span> <span style="font-size:0.8em; color:#555;">${t.desc}</span>`;
                col.appendChild(lbl);
            });
            container.appendChild(col);
        }
    },

    checkLimit: function(name, limit) {
        const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
        if(checked.length > limit) {
            alert(`Solo puedes elegir ${limit}.`);
            event.target.checked = false;
        }
    },

    getMod: function(val) {
        if(val <= 3) return -3;
        if(val <= 6) return -2;
        if(val <= 9) return -1;
        if(val <= 12) return 0;
        if(val <= 14) return 1;
        if(val <= 16) return 2;
        return 3;
    },

    calc: function() {
        // --- 1. ATRIBUTOS ---
        const stats = {
            FUE: parseInt(document.getElementById('base_FUE').value)||8,
            DES: parseInt(document.getElementById('base_DES').value)||8,
            CON: parseInt(document.getElementById('base_CON').value)||8,
            INT: parseInt(document.getElementById('base_INT').value)||8,
            SAB: parseInt(document.getElementById('base_SAB').value)||8,
            CAR: parseInt(document.getElementById('base_CAR').value)||8
        };
        const descData = DB.descriptors[document.getElementById('sel_desc').value];
        for(let k in descData.mods) stats[k] += descData.mods[k];
        const activeTalents = Array.from(document.querySelectorAll('input[name="chk_talents"]:checked'));
        document.getElementById('talent_count').innerText = activeTalents.length;
        if(document.querySelector('input[data-id="atleta"]:checked')) stats.DES += 1;
        let statHTML = "";
        for(let k in stats) {
            let mod = this.getMod(stats[k]);
            statHTML += `<span style="margin:0 10px">${k}: <b>${stats[k]}</b> (${mod>=0?'+':''}${mod})</span>`;
        }
        document.getElementById('stats_final_display').innerHTML = statHTML;
        
        // --- 2. SALVACIONES ---
        const profBonus = 2;
        const selCommon = document.querySelector('input[name="save_common"]:checked')?.value;
        const selUncommon = document.querySelector('input[name="save_uncommon"]:checked')?.value;
        let savesHTML = "";
        const statOrder = ["FUE", "DES", "CON", "INT", "SAB", "CAR"];
        statOrder.forEach(stat => {
            let baseMod = this.getMod(stats[stat]);
            let isProf = (stat === selCommon || stat === selUncommon);
            let total = baseMod + (isProf ? profBonus : 0);
            let style = isProf ? "color:var(--ink-red); text-decoration:underline;" : "color:var(--ink-main);";
            savesHTML += `<div style="${style}"><div style="font-size:0.7em;">${stat}</div>${total>=0?'+':''}${total}</div>`;
        });
        document.getElementById('saves_display').innerHTML = savesHTML;

        // --- 3. SKILLS ---
        const skillCounts = {};
        descData.grant.forEach(s => skillCounts[s] = (skillCounts[s]||0) + 1);
        ['chk_arq', 'chk_bg'].forEach(grp => {
            document.querySelectorAll(`input[name="${grp}"]:checked`).forEach(chk => {
                skillCounts[chk.value] = (skillCounts[chk.value]||0) + 1;
            });
        });
        const finalDiv = document.getElementById('final_skills_list');
        finalDiv.innerHTML = "";
        for(let s in skillCounts) {
            let grade = skillCounts[s] >= 2 ? 1 : 0;
            let tag = document.createElement('span');
            tag.className = `skill-tag ${grade===1 ? 'grade-1' : ''}`;
            tag.innerText = `${s} [G${grade}]`;
            finalDiv.appendChild(tag);
        }

        // --- 4. COMBAT & RECURSOS ---
        const arqKey = document.getElementById('sel_arq').value;
        const arqData = DB.archetypes[arqKey];
        const armor = DB.armors[document.getElementById('sel_armor').value];
        const weapon = DB.weapons[document.getElementById('sel_weapon').value];
        const shield = DB.shields[document.getElementById('sel_shield').value];
        
        // Recursos Base
        const pv = arqData.pv + stats.CON; 
        const flesh = stats.CON;
        let bonusIng = document.querySelector('input[data-id="despertar"]:checked') ? 6 : 0;
        let bonusIni = document.querySelector('input[data-id="alerta"]:checked') ? 5 : 0;
        const maxFis = Math.max(stats.FUE, stats.DES);
        const maxMen = Math.max(stats.INT, stats.SAB, stats.CAR);
        const adr = maxFis + 1 + arqData.adr;
        const ing = maxMen + 1 + arqData.ing + bonusIng;
        
        // CA
        let modDes = this.getMod(stats.DES);
        let ca = armor.ca;
        let defNatural = document.querySelector('input[data-id="def_nat"]:checked');
        if (armor.type === 'none' && defNatural) {
            ca = 10 + modDes + this.getMod(stats.CON);
        } else {
            if (armor.type === 'light' || armor.type === 'none') ca += modDes;
            if (armor.type === 'medium') ca += Math.min(modDes, 2);
        }
        ca += shield.bonus;
        ca += arqData.ca;
        if(document.getElementById('chk_magic_ac').checked) ca += 1;

        // --- L√ìGICA DE ATAQUE AVANZADA ---
        let atkAttrVal = stats.FUE;
        if (weapon.stat === 'DES') atkAttrVal = stats.DES;
        if (weapon.stat === 'FIN') atkAttrVal = Math.max(stats.FUE, stats.DES);
        let baseAtkMod = this.getMod(atkAttrVal);

        // Chequeo de Competencia y Requisitos
        let isProficient = false;
        let meetsReq = (weapon.req === 0) || (stats.FUE >= weapon.req || stats.DES >= weapon.req); 
        let alertMsg = "";

        if (arqKey === "valor") { 
            // Audaz: Competente con todo, Ignora Requisitos
            isProficient = true; 
            meetsReq = true; 
        } 
        else if (arqKey === "gracia") { 
            // Sutil: Competente si Simple o Sutil. Ignora req si es Sutil
            if (weapon.cat === "simple" || weapon.prop === "sutil") {
                isProficient = true;
                if (weapon.prop === "sutil") meetsReq = true;
            }
        } 
        else { 
            // Sagaz: Competente solo Simple. Respeta Requisitos
            if (weapon.cat === "simple") isProficient = true;
        }

        // Calculo Final de Ataque
        let totalAtk = baseAtkMod + (isProficient ? 2 : 0);
        
        if (!meetsReq) {
            alertMsg = "‚ö†Ô∏è Faltan requisitos de Atributo. (Penalizado)";
            // En OSR no cumplir requisito suele impedir el uso o quitar bonos. 
            // Aqu√≠ quitamos el bono de competencia si lo tuviera, o aplicamos desventaja l√≥gica
            if(isProficient) totalAtk -= 2; 
        }

        // Calculo de Magia
        let maxMentalMod = Math.max(this.getMod(stats.INT), this.getMod(stats.SAB), this.getMod(stats.CAR));
        let magicAtkMod = maxMentalMod + 2;

        // Da√±o
        let dmgAttr = stats.FUE;
        if (weapon.stat === 'DES') dmgAttr = stats.DES;
        if (weapon.stat === 'FIN') dmgAttr = Math.max(stats.FUE, stats.DES);
        let dmgMod = this.getMod(dmgAttr);
        let dmgSign = dmgMod > 0 ? "+" + dmgMod : "";
        let finalDmg = `${weapon.dmg} ${dmgSign}`;
        
        const cargaTotal = armor.slots + weapon.slots + shield.slots;
        const cargaMax = stats.FUE;

        // UI Updates
        document.getElementById('armor_info').innerText = `Tipo: ${armor.type.toUpperCase()} | Slots: ${armor.slots}`;
        document.getElementById('weapon_info').innerHTML = `Ataque: <span style="color:var(--ink-red); font-weight:bold;">${totalAtk >= 0 ? '+' : ''}${totalAtk}</span> | Da√±o: ${finalDmg} | Slots: ${weapon.slots}`;
        document.getElementById('prof_alert').innerText = alertMsg;

        document.getElementById('res_pv').innerText = pv;
        document.getElementById('res_carne').innerText = flesh;
        document.getElementById('res_carga').innerText = cargaTotal + " / " + cargaMax;
        document.getElementById('res_carga').style.color = cargaTotal > cargaMax ? "var(--ink-red)" : "var(--ink-main)";
        document.getElementById('res_adr').innerText = adr;
        document.getElementById('res_ing').innerText = ing;
        document.getElementById('res_ca').innerText = ca;
        document.getElementById('res_ini').innerText = (modDes + bonusIni >= 0 ? "+" : "") + (modDes + bonusIni);
        document.getElementById('res_atq_mag').innerText = (magicAtkMod >= 0 ? "+" : "") + magicAtkMod;
        document.getElementById('res_filo_val').innerText = document.getElementById('sel_filo').value;
    },

    randomize: function() {
        ['base_FUE','base_DES','base_CON','base_INT','base_SAB','base_CAR'].forEach(id => {
            document.getElementById(id).value = Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+3;
        });
        
        const randSel = (id) => {
            const sel = document.getElementById(id);
            sel.selectedIndex = Math.floor(Math.random() * sel.options.length);
        };
        randSel('sel_desc');
        randSel('sel_arq'); 
        randSel('sel_bg');
        randSel('sel_shield');

        // Logic de Armadura
        const arq = document.getElementById('sel_arq').value;
        let validArmorTypes = arq === 'espiritu' ? ['none'] : (arq === 'gracia' ? ['none', 'light'] : ['none','light','medium','heavy']);
        const armorKeys = Object.keys(DB.armors).filter(k => validArmorTypes.includes(DB.armors[k].type));
        document.getElementById('sel_armor').value = armorKeys[Math.floor(Math.random() * armorKeys.length)];

        // Logic de Arma (Coherencia con Competencia)
        let validWeapons = [];
        for (let wKey in DB.weapons) {
            let w = DB.weapons[wKey];
            let isValid = false;
            // Audaz: Todo
            if (arq === 'valor') isValid = true;
            // Sutil: Simple o Sutil
            else if (arq === 'gracia') { if (w.cat === 'simple' || w.prop === 'sutil') isValid = true; }
            // Sagaz: Solo Simple
            else { if (w.cat === 'simple') isValid = true; }
            
            if(isValid) validWeapons.push(wKey);
        }
        document.getElementById('sel_weapon').value = validWeapons[Math.floor(Math.random() * validWeapons.length)];

        this.updateOptions(true); 

        // Elegir Filo Aleatorio
        randSel('sel_filo');

        // Checks
        const randRadio = (name) => {
            const radios = Array.from(document.querySelectorAll(`input[name="${name}"]`));
            radios.forEach(r => r.checked = false);
            radios[Math.floor(Math.random() * radios.length)].checked = true;
        };
        randRadio('save_common'); randRadio('save_uncommon');
        const randChecks = (name, limit) => {
            const boxes = Array.from(document.querySelectorAll(`input[name="${name}"]`));
            boxes.forEach(b => b.checked = false);
            boxes.sort(() => Math.random() - 0.5);
            boxes.slice(0, limit).forEach(b => b.checked = true);
        };
        const arqLimit = DB.archetypes[document.getElementById('sel_arq').value].limit;
        randChecks('chk_arq', arqLimit); randChecks('chk_bg', 2); randChecks('chk_talents', 3);
        
        this.calc();
    },

    clear: function() {
        ['base_FUE','base_DES','base_CON','base_INT','base_SAB','base_CAR'].forEach(id => { document.getElementById(id).value = 8; });
        document.getElementById('char_name').value = "";
        const resets = ['sel_desc', 'sel_arq', 'sel_bg', 'sel_armor', 'sel_weapon', 'sel_shield'];
        resets.forEach(id => document.getElementById(id).selectedIndex = 0);
        const checks = document.querySelectorAll('input[type="checkbox"], input[type="radio"]');
        checks.forEach(c => c.checked = false);
        document.getElementById('char_img').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a3b2a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";
        this.updateOptions(true);
        this.calc();
    },

    saveChar: function() {
        const charName = document.getElementById('char_name').value.trim();
        if (!charName) { alert("¬°Tu h√©roe necesita un nombre!"); return; }
        let roster = JSON.parse(localStorage.getItem('sands_roster') || "{}");
        if (roster[charName] && !confirm(`¬øSobrescribir a "${charName}"?`)) return;
        const saveData = { inputs: {}, selects: {}, checks: [], portrait: document.getElementById('char_img').src };
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => saveData.inputs[el.id] = el.value);
        document.querySelectorAll('select').forEach(el => saveData.selects[el.id] = el.value);
        document.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked').forEach(el => {
            saveData.checks.push({ name: el.name, value: el.value, id: el.id });
        });
        roster[charName] = saveData;
        try {
            localStorage.setItem('sands_roster', JSON.stringify(roster));
            alert(`Guardado: ${charName}`);
        } catch (e) { alert("¬°Memoria llena! Usa im√°genes m√°s peque√±as."); }
    },

    openLoadMenu: function() {
        const roster = JSON.parse(localStorage.getItem('sands_roster') || "{}");
        const listDiv = document.getElementById('char_list');
        listDiv.innerHTML = "";
        Object.keys(roster).forEach(name => {
            const row = document.createElement('div');
            row.className = 'char-row';
            row.innerHTML = `<span class="char-info">${name}</span><div><button class="btn-mini btn-load" onclick="app.loadSpecificChar('${name}')">CARGAR</button><button class="btn-mini btn-del" onclick="app.deleteChar('${name}')">BORRAR</button></div>`;
            listDiv.appendChild(row);
        });
        document.getElementById('char_manager').showModal();
    },

    loadSpecificChar: function(name) {
        const roster = JSON.parse(localStorage.getItem('sands_roster') || "{}");
        const data = roster[name];
        if (!data) return;
        for (let id in data.inputs) { const el = document.getElementById(id); if (el) el.value = data.inputs[id]; }
        for (let id in data.selects) { const el = document.getElementById(id); if (el) el.value = data.selects[id]; }
        if (data.portrait) document.getElementById('char_img').src = data.portrait;
        this.updateOptions(true); 
        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => el.checked = false);
        data.checks.forEach(item => {
            let el = document.getElementById(item.id);
            if (!el) el = document.querySelector(`input[name="${item.name}"][value="${item.value}"]`);
            if (el) el.checked = true;
        });
        this.calc();
        document.getElementById('char_manager').close();
    },

    deleteChar: function(name) {
        if(confirm(`¬øBorrar a "${name}"?`)) {
            let roster = JSON.parse(localStorage.getItem('sands_roster') || "{}");
            delete roster[name];
            localStorage.setItem('sands_roster', JSON.stringify(roster));
            this.openLoadMenu();
        }
    }
};

window.onload = function() { app.init(); };

// PWA
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  const btnInstall = document.getElementById('btn-install');
  if(btnInstall) {
      btnInstall.style.display = 'block';
      btnInstall.addEventListener('click', () => {
        btnInstall.style.display = 'none'; deferredPrompt.prompt(); deferredPrompt = null;
      });
  }
});
</script>

</body>
</html>
