<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f3e5ce">
    <title>Stars & Sorcery: Character Sheet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=IM+Fell+English+SC&display=swap" rel="stylesheet">

    <style>
        /* === 1. SISTEMA DE DISE√ëO === */
        :root {
            --bg-paper: #f3e5ce; --bg-light: #fffef8; --ink-main: #1a1a1a; --ink-red: #8b0000; --ink-accent: #4a3b2a;
            --shadow-soft: 4px 4px 0px rgba(74, 59, 42, 0.15); --border-thick: 2px solid var(--ink-main);
            --font-title: 'IM Fell English SC', serif; --font-body: 'Crimson Text', serif; --font-mono: 'Courier Prime', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-body); background-color: var(--bg-paper); color: var(--ink-main);
            padding: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E"), radial-gradient(#d6c6a8 1px, transparent 1px);
            background-size: 150px 150px, 20px 20px; font-size: 16px; line-height: 1.5;
        }

        /* === 2. TIPOGRAF√çA Y ESTRUCTURA === */
        .main-title {
            font-family: var(--font-title); color: var(--ink-red); font-size: 3.5rem; text-align: center;
            margin: 0 auto 30px auto; max-width: 900px; border-bottom: 3px double var(--ink-red);
            letter-spacing: 2px; line-height: 1; padding-bottom: 15px; text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }

        h1, h2, h3 { font-family: var(--font-title); font-weight: 400; color: var(--ink-main); margin: 0; }
        h2 { color: var(--ink-red); font-size: 1.6em; border-bottom: 1px solid var(--ink-accent); padding-bottom: 5px; margin-bottom: 15px; letter-spacing: 0.5px; }
        h3 { font-size: 1.1em; text-decoration: underline; text-decoration-color: var(--ink-accent); text-underline-offset: 3px; margin-bottom: 8px; color: var(--ink-accent); }

        .container { max-width: 1150px; margin: auto; display: grid; grid-template-columns: 320px 1fr; gap: 30px; align-items: start; }

        .section, .sidebar {
            background: var(--bg-light); border: var(--border-thick); padding: 20px; margin-bottom: 25px; 
            box-shadow: var(--shadow-soft); position: relative;
        }
        .section::before {
            content: "‚ùñ"; position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
            background: var(--bg-light); padding: 0 10px; font-size: 1.2em; color: var(--ink-accent);
        }

        .sidebar {
            padding: 20px; position: sticky; top: 20px; max-height: calc(100vh - 40px);
            overflow-y: auto; overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        /* === 3. RETRATO Y INPUTS === */
        .portrait-frame {
            width: 276px; height: 380px; margin: 0 auto 20px auto;
            border: 4px double var(--ink-main); border-radius: 2px;
            overflow: hidden; background: #e8dcc5; cursor: pointer;
            position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            transition: border-color 0.2s;
        }
        .portrait-frame:hover { border-color: var(--ink-red); }
        .portrait-frame img { width: 100%; height: 100%; object-fit: cover; display: block; filter: sepia(0.2); }
        .portrait-label {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(26, 26, 26, 0.85); color: #f3e5ce; font-size: 0.75em;
            text-align: center; padding: 6px; font-family: var(--font-mono); letter-spacing: 1px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; text-transform: uppercase;
        }
        .portrait-frame:hover .portrait-label { opacity: 1; }

        /* === 5. INPUTS (OPTIMIZADO PARA MOVIL) === */
        label { font-family: var(--font-title); color: var(--ink-accent); font-size: 1.1em; display: block; margin-top: 12px; }
        
        input[type="text"], input[type="number"], select, textarea {
            background: transparent; border: none; border-bottom: 2px dashed #999;
            font-family: var(--font-mono); font-weight: 700; color: var(--ink-main);
            padding: 6px 0; width: 100%; font-size: 1.1em; transition: 0.2s; border-radius: 0;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden; 
        }

        /* Ajuste espec√≠fico para selects en m√≥viles */
        select {
            padding-right: 20px; 
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%231a1a1a%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0 top 50%;
            background-size: .65em auto;
        }

        textarea { 
            resize: none; min-height: 6em; overflow: hidden; white-space: normal;
            font-size: 0.95em; color: #444; font-style: italic; line-height: 1.4;
            margin-top: 8px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.4); padding: 8px;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-bottom: 2px solid var(--ink-red); background: rgba(139, 0, 0, 0.03); }
        input[type="number"] { text-align: center; font-size: 1.4em; }

        input[type="radio"], input[type="checkbox"] {
            appearance: none; width: 16px; height: 16px; border: 2px solid var(--ink-main);
            cursor: pointer; display: inline-block; vertical-align: middle; margin-right: 6px;
            position: relative; top: -2px; background: #fff;
        }
        input[type="radio"] { border-radius: 50%; }
        input[type="radio"]:checked, input[type="checkbox"]:checked { background-color: var(--ink-red); border-color: var(--ink-red); box-shadow: inset 0 0 0 3px #fff; }

        /* === 6. GRIDS Y STATS === */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .stats-grid, .stats-output-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .stat-box, .stat-box-dark { text-align: center; font-family: var(--font-mono); font-size: 1em; padding: 8px 2px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .stat-box { border: 1px solid #ccc; background: #fff; }
        .stat-box-dark { color: #fff; }
        .skill-area { border: 1px solid #ccc; padding: 10px; background: #fff; max-height: 220px; overflow-y: auto; scrollbar-width: thin; }
        .skill-opt { cursor: pointer; display: block; margin-bottom: 5px; font-size: 0.95em; }
        .skill-opt:hover { background-color: #f0f0f0; }

        .big-stat { border: 4px double var(--ink-main); text-align: center; padding: 15px; margin-bottom: 20px; border-radius: 50% 50% 0 0; background: #fff; }
        .big-stat h3 { font-size: 3.8em; color: var(--ink-red); line-height: 0.9; margin-bottom: 5px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding: 8px 0; font-size: 1.1em; }
        .stat-val { font-family: var(--font-mono); font-weight: 700; font-size: 1.25em; }

        /* === 7. BOTONES === */
        .action-bar { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 10px; margin-bottom: 20px; width: 100%; }
        
        .btn {
            font-family: var(--font-title); font-size: 1.1em; padding: 10px 0; width: 100%; cursor: pointer;
            text-align: center; text-transform: uppercase; letter-spacing: 1px; transition: all 0.15s ease;
            box-sizing: border-box; background: #fff; border: 2px solid var(--ink-main); color: var(--ink-main);
            box-shadow: 3px 3px 0px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px rgba(0,0,0,0.15); }
        .btn:hover { background: var(--ink-red); color: #fff; border-color: var(--ink-red); }
        .btn-clear { background: #f4f4f4; border: 2px dashed var(--ink-main); color: var(--ink-main); box-shadow: none; }
        .btn-clear:hover { background: var(--ink-main); color: #fff; border-color: var(--ink-main); }
        
        .btn-confirm { background: var(--ink-main); color: #fff; border: none; padding: 12px; width: 100%; cursor: pointer; font-family: var(--font-title); font-size: 1.2em; margin-top: 15px; letter-spacing: 1px; flex-shrink: 0; }
        .btn-confirm:hover { background: var(--ink-accent); }
        .btn-edit { font-size: 0.8em; padding: 6px 15px; background: transparent; border: 1px solid var(--ink-main); cursor: pointer; display: block; margin: 15px auto 0 auto; font-family: var(--font-mono); text-transform: uppercase; transition: 0.2s; }
        .btn-edit:hover { background: var(--ink-main); color: #fff; }
        
        /* Boton de Ajustes (Tuerca) */
        .btn-settings { font-size: 1.5em; padding: 0; background: var(--ink-main); color: #fff; border: none; }
        .btn-settings:hover { background: var(--ink-accent); }
        
        /* Botones dentro del Modal de Ajustes */
        .settings-grid { display: flex; flex-direction: column; gap: 12px; }
        .btn-modal { width: 100%; text-align: left; padding: 12px 20px; }

        .btn-mini { padding: 6px 12px; margin-left: 5px; cursor: pointer; border: 1px solid var(--ink-main); font-family: var(--font-mono); font-size: 0.85em; background: #fff; transition:0.2s; text-transform:uppercase; font-weight:bold; }
        .btn-load:hover { background: var(--ink-main); color: #fff; }
        .btn-del { color: var(--ink-red); border-color: var(--ink-red); cursor:pointer;}
        .btn-del:hover { background: var(--ink-red); color: #fff; }
        .btn-close { background: transparent; border: none; color: #fff; font-size: 1.5em; cursor: pointer; line-height: 1; padding: 5px 10px; border-radius: 4px; }
        .btn-close:hover { background: rgba(255,255,255,0.2); }

        /* === 8. MODALES GENERALES === */
        dialog.modal-osr { 
            background: var(--bg-paper); color: var(--ink-main); border: 4px double var(--ink-main); 
            width: 95%; padding: 0; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            position: fixed; inset: 0; margin: auto; 
            max-height: 90vh; display: none; flex-direction: column; z-index: 1000;
        }
        dialog.modal-osr[open] { display: flex; }
        dialog::backdrop { background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(4px); }
        
        .modal-header { background: var(--ink-main); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 2px solid var(--ink-accent); }
        .modal-header h2 { color: #fff; font-size: 1.3em; margin: 0; border: none; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        
        .char-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #ccc; padding: 10px 5px; background: rgba(255,255,255,0.5); margin-bottom: 5px; }
        .char-row:hover { background: #fff; }
        .char-actions { display: flex; gap: 5px; }

        /* Gestor de Talentos */
        #talent_modal { max-width: 900px; height: 85vh; }
        
        .talent-manager-layout { display: grid; grid-template-columns: 220px 1fr; gap: 20px; height: 100%; overflow: hidden; }
        .tm-sidebar { border-right: 2px solid #ccc; padding-right: 15px; overflow-y: auto; }
        .tm-content { overflow-y: auto; padding-right: 5px; }
        
        .cat-btn { display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 5px; background: #e8dcc5; border: 1px solid var(--ink-accent); cursor: pointer; font-family: var(--font-title); font-size: 1.1em; transition:0.2s; }
        .cat-btn:hover, .cat-btn.active { background: var(--ink-red); color: #fff; border-color: var(--ink-red); transform: translateX(5px); }
        
        .talent-card { background: #fff; border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); display: flex; align-items: flex-start; gap: 15px; transition: all 0.2s; }
        .talent-card.selected { background-color: #f0fff4; border: 2px solid #2e7d32; box-shadow: 4px 4px 0 rgba(46, 125, 50, 0.2); }
        .talent-card input { width: 22px; height: 22px; margin-top: 5px; flex-shrink: 0; accent-color: var(--ink-red); cursor: pointer; }
        .talent-info h4 { margin: 0 0 5px 0; font-size: 1.25em; color: var(--ink-accent); text-transform: uppercase; border-bottom: 1px dashed #ccc; padding-bottom:3px; }
        .talent-desc { font-size: 1em; color: #444; line-height: 1.5; }

        /* === 9. EDITOR DE CROP === */
        #crop_modal { 
            width: 90vw; max-width: 800px; 
            height: 80vh; max-height: 600px;
            background: #1a1a1a; border-color: #444; overflow: hidden;
        }
        #crop_modal .modal-header { background: #000; border-bottom: 1px solid #333; }
        #crop_modal .modal-body { padding: 0; background: #222; display: block; overflow: hidden; height: 100%; }
        
        .crop-layout { display: flex; flex-direction: row; height: 100%; width: 100%; }
        .crop-workspace {
            flex-grow: 1; 
            background: #2a2a2a; 
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }
        .crop-sidebar {
            width: 260px; flex-shrink: 0;
            background: #333; border-left: 1px solid #444;
            padding: 20px; 
            display: flex; flex-direction: column; justify-content: center; gap: 25px;
            color: #eee; overflow-y: auto;
        }
        .crop-container { 
            width: 276px; height: 380px; flex-shrink: 0; 
            border: 2px solid var(--ink-red); 
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.85);
            position: relative; overflow: hidden; 
            background: #000; touch-action: none; z-index: 10;
        }
        .crop-image { position: absolute; top: 0; left: 0; transform-origin: top left; cursor: grab; }
        .crop-image:active { cursor: grabbing; }
        .crop-btn-save { width: 100%; padding: 15px; font-size: 1.1em; background: var(--ink-red); color: white; border: none; cursor: pointer; font-family: var(--font-title); letter-spacing: 1px; transition: 0.2s; border-radius: 4px; }
        .crop-btn-save:hover { background: #a00000; transform: scale(1.02); }
        .zoom-slider { width: 100%; accent-color: var(--ink-red); cursor: pointer; height: 6px; background: #555; border-radius: 3px; }

        /* Otros */
        .summary-view { border: 1px solid var(--ink-accent); background: #fffdf5; padding: 15px; margin-top: 15px; }
        #stats_final_display { background: var(--ink-main); color: #fff; padding: 15px; margin-top: 20px; border: 2px solid var(--ink-main); }
        .db-locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        #db-status-overlay { display: block; margin-bottom: 15px; padding: 10px; background: #fff; border: 2px dashed var(--ink-red); color: var(--ink-red); text-align: center; font-weight: bold; font-family: var(--font-mono); }
        
        /* Modal de Ajustes */
        #settings_modal { max-width: 450px; }
        .settings-section { margin-bottom: 20px; }
        .settings-section h3 { font-size: 1em; text-transform: uppercase; color: #666; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px; }

        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { position: relative; top: 0; max-height: none; overflow: visible; padding: 20px; }
            .stats-grid, .stats-output-grid { grid-template-columns: repeat(3, 1fr); }
            
            #crop_modal { height: 90vh; }
            .crop-layout { flex-direction: column; }
            .crop-workspace { height: 60%; }
            .crop-sidebar { width: 100%; height: auto; border-left: none; border-top: 1px solid #444; padding: 15px; flex-direction: row; align-items: center; }
            .crop-sidebar > * { flex: 1; }
            .crop-container { transform: scale(0.8); }
            
            /* FIX GESTOR DE TALENTOS M√ìVIL: WRAP EN LUGAR DE SCROLL */
            .talent-manager-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; gap: 10px; }
            .tm-sidebar { 
                border-right: none; 
                border-bottom: 2px solid #ccc; 
                padding-bottom: 10px; 
                display: flex; 
                flex-wrap: wrap; /* Correcci√≥n Clave: WRAP */
                justify-content: center;
                gap: 8px; 
                overflow: visible; 
                white-space: normal; 
                padding-right: 0;
            }
            .cat-btn { 
                width: auto; 
                flex-grow: 1; /* Ocupar espacio disponible */
                margin-bottom: 0; 
                padding: 8px 10px; 
                font-size: 0.9em;
                text-align: center;
            }

            /* Escala de texto en m√≥viles */
            input[type="text"], input[type="number"], select, textarea { font-size: 0.95em; }
        }
    </style>
</head>
<body>

<h1 class="main-title">Stars & Sorcery</h1>

<div class="container">
    <aside class="sidebar">
        <input type="file" id="img_input" accept="image/*" style="display:none" onchange="app.startCrop(this)">
        <input type="file" id="json_char_input" accept=".json" style="display:none" onchange="app.loadJSON(this)">
        <input type="file" id="json_rules_input" accept=".json" style="display:none" onchange="app.loadRulesFile(this)">
        
        <div class="portrait-frame" onclick="document.getElementById('img_input').click()">
            <img id="char_img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='%234a3b2a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Retrato">
            <span class="portrait-label">CAMBIAR RETRATO</span>
        </div>

        <div style="margin-bottom: 20px;">
            <label>Nombre del Aventurero</label>
            <input type="text" id="char_name" placeholder="Ej: Valerius el Audaz" style="font-family: 'IM Fell English SC'; font-size: 1.4em;">
            <textarea id="char_concept" placeholder="Biograf√≠a breve, concepto o notas del personaje..."></textarea>
        </div>
        
        <div id="db-status-overlay">‚ö†Ô∏è REGLAS NO CARGADAS</div>

        <div class="action-bar">
            <button class="btn" onclick="app.randomize()">üé≤ Aleatorizar</button>
            <button class="btn btn-clear" onclick="app.clear()">üóëÔ∏è Limpiar</button>
            <button class="btn btn-settings" onclick="document.getElementById('settings_modal').showModal()">‚öôÔ∏è</button>
        </div>

        <div class="big-stat">
            <h3 id="res_pv">0</h3>
            <span style="font-family: var(--font-title); font-weight: bold; font-size:1.1em; letter-spacing:1px;">PUNTOS DE VIDA</span>
        </div>
        
        <div class="stat-row"><span>Umbral de Carne</span><span class="stat-val" id="res_carne">0</span></div>
        <div class="stat-row"><span>Clase de Armadura</span><span class="stat-val" id="res_ca">10</span></div>
        <div class="stat-row"><span>Iniciativa</span><span class="stat-val" id="res_ini">+0</span></div>
        <div class="stat-row" style="color:#6a0dad"><span>Ataque M√°gico</span><span class="stat-val" id="res_atq_mag">+2</span></div>
        
        <hr style="border:0; border-top:1px solid #ccc; margin:15px 0;">
        <div class="stat-row" style="color:var(--ink-red)"><span>Adrenalina</span><span class="stat-val" id="res_adr">0</span></div>
        <div class="stat-row" style="color:#003366"><span>Ingenio</span><span class="stat-val" id="res_ing">0</span></div>
        <div class="stat-row"><span>Filo Activo</span><span class="stat-val" id="res_filo_val">F√≠sico</span></div>
        <hr style="border:0; border-top:1px solid #ccc; margin:15px 0;">
        <div class="stat-row"><span>Carga (Slots)</span><span class="stat-val" id="res_carga">0 / 0</span></div>
        <p id="carga_warn" class="warn-text" style="display:none; color:var(--ink-red); text-align:center; font-weight:bold;">¬°SOBRECARGA!</p>
    </aside>

    <main id="main_content" class="main-content db-locked">
        <div class="section">
            <h2>I. Los Seis Pilares (8-18)</h2>
            <div id="stats_edit_view">
                <div class="stats-grid">
                    <div><label>FUE</label><input type="number" id="base_FUE" value="8" min="3" max="18" onchange="app.calc()"></div>
                    <div><label>DES</label><input type="number" id="base_DES" value="8" min="3" max="18" onchange="app.calc()"></div>
                    <div><label>CON</label><input type="number" id="base_CON" value="8" min="3" max="18" onchange="app.calc()"></div>
                    <div><label>INT</label><input type="number" id="base_INT" value="8" min="3" max="18" onchange="app.calc()"></div>
                    <div><label>SAB</label><input type="number" id="base_SAB" value="8" min="3" max="18" onchange="app.calc()"></div>
                    <div><label>CAR</label><input type="number" id="base_CAR" value="8" min="3" max="18" onchange="app.calc()"></div>
                </div>
                <div id="stats_final_display" class="stats-output-grid"></div>
                <button class="btn-confirm" onclick="app.toggleSection('stats', false)">‚úÖ Confirmar Atributos</button>
            </div>
            <div id="stats_summary_view" class="summary-view" style="display:none;">
                <div id="stats_summary_text" class="stats-output-grid"></div>
                <button class="btn-edit" onclick="app.toggleSection('stats', true)">‚úèÔ∏è Modificar</button>
            </div>
        </div>

        <div class="section">
            <h2>II. Identidad y Origen</h2>
            <div id="identity_edit_view">
                <div class="grid-2">
                    <div>
                        <label>Linaje (Raza)</label>
                        <select id="sel_desc" onchange="app.updateOptions()"></select>
                        <div id="desc_info" class="bonus-desc"></div>
                    </div>
                    <div>
                        <label>Arquetipo (Clase)</label>
                        <select id="sel_arq" onchange="app.updateOptions()"></select>
                        <div id="arq_info" class="bonus-desc"></div>
                        <label style="margin-top:15px; font-size:0.95em;">Selecci√≥n de Filo (Edge)</label>
                        <select id="sel_filo" onchange="app.calc()"></select>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label>Trasfondo</label>
                    <select id="sel_bg" onchange="app.updateOptions()"></select>
                    <div id="bg_info" class="bonus-desc"></div>
                </div>
                <button class="btn-confirm" onclick="app.toggleSection('identity', false)">‚úÖ Confirmar Identidad</button>
            </div>
            <div id="identity_summary_view" class="summary-view" style="display:none;">
                <div id="identity_summary_text" class="summary-text"></div>
                <button class="btn-edit" onclick="app.toggleSection('identity', true)">‚úèÔ∏è Modificar</button>
            </div>
        </div>

        <div class="section">
            <h2>III. Tiradas de Salvaci√≥n (Bono +2)</h2>
            <div id="saves_edit_view">
                <div class="grid-2">
                    <div>
                        <h3>Comunes</h3>
                        <label class="skill-opt"><input type="radio" name="save_common" value="DES" onchange="app.calc()"> Destreza (DES)</label>
                        <label class="skill-opt"><input type="radio" name="save_common" value="CON" onchange="app.calc()"> Constituci√≥n (CON)</label>
                        <label class="skill-opt"><input type="radio" name="save_common" value="SAB" onchange="app.calc()"> Sabidur√≠a (SAB)</label>
                    </div>
                    <div>
                        <h3>Poco Comunes</h3>
                        <label class="skill-opt"><input type="radio" name="save_uncommon" value="FUE" onchange="app.calc()"> Fuerza (FUE)</label>
                        <label class="skill-opt"><input type="radio" name="save_uncommon" value="INT" onchange="app.calc()"> Intelecto (INT)</label>
                        <label class="skill-opt"><input type="radio" name="save_uncommon" value="CAR" onchange="app.calc()"> Carisma (CAR)</label>
                    </div>
                </div>
                <div id="saves_display" style="margin-top: 20px; border-top: 2px double var(--ink-main); padding-top: 10px; display: grid; grid-template-columns: repeat(6, 1fr); text-align: center; font-family: var(--font-mono); font-weight: bold; font-size: 1.1em;"></div>
                <button class="btn-confirm" onclick="app.toggleSection('saves', false)">‚úÖ Confirmar Salvaciones</button>
            </div>
            <div id="saves_summary_view" class="summary-view" style="display:none;">
                <div id="saves_summary_text" class="stats-output-grid"></div>
                <button class="btn-edit" onclick="app.toggleSection('saves', true)">‚úèÔ∏è Modificar</button>
            </div>
        </div>

        <div class="section">
            <h2>IV. Habilidades y Maestr√≠a</h2>
            <div id="skills_edit_view">
                <div class="grid-2">
                    <div>
                        <h3>Por Arquetipo (Elige <span id="limit_arq">2</span>)</h3>
                        <div id="skills_arq" class="skill-area"></div>
                    </div>
                    <div>
                        <h3>Por Trasfondo (Elige 2)</h3>
                        <div id="skills_bg" class="skill-area"></div>
                    </div>
                </div>
                <button class="btn-confirm" onclick="app.toggleSection('skills', false)">‚úÖ Confirmar Selecci√≥n</button>
            </div>
            <div id="skills_summary_view" style="display:none;">
                <label style="text-align:center; margin-bottom:10px; display:block; font-weight:bold; color:var(--ink-main);">MAESTR√çAS FINALES</label>
                <div id="final_skills_list" style="text-align:center; line-height:1.8;"></div>
                <button class="btn-edit" onclick="app.toggleSection('skills', true)">‚úèÔ∏è Modificar Habilidades</button>
            </div>
        </div>

        <div class="section">
            <h2>V. Talentos (Elige 3)</h2>
            <div style="text-align:center; margin-bottom:10px;">
                <div style="font-family:var(--font-mono); margin-bottom:10px;">
                    Seleccionados: <span id="talent_count_main" style="font-weight:bold; color:var(--ink-red);">0</span>/3
                </div>
                <button class="btn" style="max-width:300px; margin:auto;" onclick="app.openTalentManager()">‚ú® Abrir Gestor de Talentos</button>
            </div>
            <div id="talents_summary_view" class="summary-view" style="display:none;">
                <label style="text-align:center; color:var(--ink-red); margin-bottom:15px; display:block; font-weight:bold;">TALENTOS ACTIVOS</label>
                <div id="talents_summary_list"></div>
            </div>
        </div>

        <div class="section">
            <h2>VI. Equipo de Combate</h2>
            <div id="combat_edit_view">
                <div class="grid-2">
                    <div>
                        <label>Armadura</label>
                        <select id="sel_armor" onchange="app.calc()"></select>
                        <div id="armor_info" class="bonus-desc"></div>
                    </div>
                    <div>
                        <label>Escudo & Extras</label>
                        <select id="sel_shield" onchange="app.calc()"></select>
                        <div style="margin-top:10px;">
                            <label class="skill-opt" style="font-size:0.9em; color:var(--ink-accent);">
                                <input type="checkbox" id="chk_magic_ac" onchange="app.calc()"> Bono M√°gico (+1 CA)
                            </label>
                        </div>
                    </div>
                </div>
                <label style="margin-top:15px;">Arma Principal</label>
                <select id="sel_weapon" onchange="app.calc()"></select>
                <div style="margin-top: 20px; text-align: center; border: 2px solid var(--ink-main); padding: 10px;">
                    <label style="margin:0; font-size:0.9em;">ESTAD√çSTICAS</label>
                    <p id="weapon_info"></p>
                    <div id="prof_alert" style="color:var(--ink-red); font-size:0.85em; margin-top:5px; font-weight:bold;"></div>
                </div>
                <button class="btn-confirm" onclick="app.toggleSection('combat', false)">‚úÖ Confirmar Equipo</button>
            </div>
            <div id="combat_summary_view" class="summary-view" style="display:none;">
                <div id="combat_summary_text" class="summary-text" style="line-height:1.6;"></div>
                <div id="combat_summary_stats" style="text-align:center; margin-top:12px; font-family:var(--font-mono); font-weight:bold; color:var(--ink-red); font-size:1.1em;"></div>
                <button class="btn-edit" onclick="app.toggleSection('combat', true)">‚úèÔ∏è Modificar</button>
            </div>
        </div>
    </main>
</div>

<dialog id="settings_modal" class="modal-osr">
    <div class="modal-header">
        <h2>‚öôÔ∏è Ajustes y Datos</h2>
        <button type="button" class="btn-close" onclick="document.getElementById('settings_modal').close()">‚úñ</button>
    </div>
    <div class="modal-body">
        <div class="settings-section">
            <h3>üìñ Reglas del Juego</h3>
            <button class="btn btn-modal btn-rules" onclick="document.getElementById('json_rules_input').click()">üìö Cargar Archivo de Reglas</button>
        </div>
        
        <div class="settings-section">
            <h3>üíæ Persistencia Local (Navegador)</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-modal" onclick="app.saveChar()">üíæ Guardar</button>
                <button class="btn btn-modal" onclick="app.openLoadMenu()">üìÇ Cargar</button>
            </div>
        </div>

        <div class="settings-section">
            <h3>üìÇ Archivos (JSON)</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-modal" onclick="app.exportJSON()">üì§ Exportar</button>
                <button class="btn btn-modal" onclick="app.triggerLoadJSON()">üì• Importar</button>
            </div>
        </div>
    </div>
</dialog>

<dialog id="talent_modal" class="modal-osr">
    <div class="modal-header">
        <h2>‚ú® Gestor de Talentos</h2>
        <button type="button" class="btn-close" onclick="app.closeTalentManager()">‚úñ</button>
    </div>
    <div class="modal-body talent-manager-layout">
        <div class="tm-sidebar" id="tm_categories"></div>
        <div class="tm-content" id="tm_list">
            <p style="text-align:center; color:#666; margin-top:50px;">Selecciona una categor√≠a a la izquierda para ver los talentos disponibles.</p>
        </div>
    </div>
    <div style="padding:10px; background:#e8dcc5; border-top:2px solid var(--ink-main); display:flex; justify-content:space-between; align-items:center;">
        <button type="button" class="btn-del" style="width:auto; margin:0; padding:5px 15px; font-size:0.8em;" onclick="app.clearTalents()">üóëÔ∏è Limpiar Selecci√≥n</button>
        <div style="display:flex; align-items:center; gap:15px;">
            <span style="font-family:var(--font-mono); font-weight:bold;">Seleccionados: <span id="talent_count_modal">0</span>/3</span>
            <button type="button" class="btn-confirm" style="width:auto; margin:0; padding:5px 20px;" onclick="app.closeTalentManager()">Confirmar</button>
        </div>
    </div>
</dialog>

<dialog id="char_manager" class="modal-osr">
    <div class="modal-header">
        <h2>üìú Libro de H√©roes</h2>
        <button type="button" class="btn-close" onclick="document.getElementById('char_manager').close()">‚úñ</button>
    </div>
    <div id="char_list" class="modal-body"></div>
</dialog>

<dialog id="crop_modal" class="modal-osr">
    <div class="modal-header" style="background:#000; border-bottom:1px solid #444;">
        <h2 style="color:#eee;">Ajustar Retrato</h2>
        <button type="button" class="btn-close" onclick="document.getElementById('crop_modal').close()">‚úñ</button>
    </div>
    <div class="modal-body">
        <div class="crop-layout">
            <div class="crop-workspace">
                <div class="crop-container" id="crop_container" onmousedown="app.startDrag(event)" ontouchstart="app.startDrag(event)">
                    <img id="crop_preview" class="crop-image" draggable="false">
                </div>
            </div>
            <div class="crop-sidebar">
                <p style="font-size:0.9em; color:#bbb; line-height:1.4;">Arrastra la imagen dentro del marco rojo para encuadrarla.</p>
                <div>
                    <label style="color:#fff; display:block; margin-bottom:8px;">Zoom</label>
                    <input type="range" id="crop_zoom" class="zoom-slider" step="0.01" oninput="app.updateCropView()">
                </div>
                <button type="button" class="crop-btn-save" onclick="app.applyCrop()">GUARDAR RECORTE</button>
            </div>
        </div>
    </div>
</dialog>

<script>
// --- MOTOR PRINCIPAL ---
const app = {
    DB: {}, 
    cropState: { img: null, x: 0, y: 0, zoom: 1, isDragging: false, lastX: 0, lastY: 0 },
    activeTalentCategory: null,

    init: function() {
        const savedRules = localStorage.getItem('sands_game_rules');
        if (savedRules) {
            try {
                this.DB = JSON.parse(savedRules);
                this.unlockApp();
            } catch(e) { console.error("Reglas guardadas corruptas."); }
        }

        document.getElementById('char_concept').addEventListener('input', function() { app.autoResize('char_concept'); });
        window.addEventListener('mouseup', () => app.endDrag());
        window.addEventListener('touchend', () => app.endDrag());
        window.addEventListener('mousemove', (e) => app.doDrag(e));
        window.addEventListener('touchmove', (e) => app.doDrag(e));
    },

    loadRulesFile: function(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const rules = JSON.parse(e.target.result);
                if(!rules.descriptors || !rules.archetypes || !rules.weapons) { throw new Error("Formato inv√°lido"); }
                app.DB = rules;
                try { localStorage.setItem('sands_game_rules', JSON.stringify(rules)); } catch(e){}
                app.unlockApp();
                document.getElementById('settings_modal').close(); // Cerrar ajustes al cargar
                alert("¬°Reglas cargadas correctamente!");
            } catch (err) { alert("Error: El archivo JSON de reglas no es v√°lido."); console.error(err); }
        };
        reader.readAsText(input.files[0]);
        input.value = "";
    },

    unlockApp: function() {
        document.getElementById('main_content').classList.remove('db-locked');
        document.getElementById('db-status-overlay').style.display = 'none';
        
        this.fillSelect('sel_desc', this.DB.descriptors);
        this.fillSelect('sel_arq', this.DB.archetypes);
        this.fillSelect('sel_bg', this.DB.backgrounds);
        this.fillSelect('sel_armor', this.DB.armors);
        this.fillSelect('sel_weapon', this.DB.weapons);
        this.fillSelect('sel_shield', this.DB.shields);
        
        this.initTalentManager();
        this.updateOptions(true);
    },

    // --- GESTOR DE TALENTOS ---
    initTalentManager: function() {
        if (!this.DB.talents) return;
        const catContainer = document.getElementById('tm_categories');
        catContainer.innerHTML = "";
        
        Object.keys(this.DB.talents).forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.type = 'button';
            btn.innerText = key.charAt(0).toUpperCase() + key.slice(1);
            btn.onclick = () => app.showTalentCategory(key, btn);
            catContainer.appendChild(btn);
        });
    },

    openTalentManager: function() {
        document.getElementById('talent_modal').showModal();
        if (!this.activeTalentCategory && this.DB.talents) {
            const firstKey = Object.keys(this.DB.talents)[0];
            const firstBtn = document.querySelector('.cat-btn');
            if(firstKey) this.showTalentCategory(firstKey, firstBtn);
        } else if (this.activeTalentCategory) {
            const activeBtn = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.innerText.toLowerCase() === this.activeTalentCategory.toLowerCase());
            this.showTalentCategory(this.activeTalentCategory, activeBtn);
        }
        this.updateTalentCountDisplay();
    },

    closeTalentManager: function() {
        const modal = document.getElementById('talent_modal');
        modal.close();
        this.showTalentSummary();
        this.updateTalentCountDisplay();
        this.calc(); 
    },

    showTalentCategory: function(key, btnElement) {
        this.activeTalentCategory = key;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        const listContainer = document.getElementById('tm_list');
        listContainer.innerHTML = "";

        const talents = this.DB.talents[key];
        if (!talents) return;

        talents.forEach(t => {
            const card = document.createElement('div');
            const isChecked = document.querySelector(`input[name="chk_talents_hidden"][value="${t.name}"]`) ? true : false;
            card.className = `talent-card ${isChecked ? 'selected' : ''}`;
            
            let extraAttr = t.id ? `data-id="${t.id}"` : "";
            
            let extraHTML = "";
            if (t.id === 'atleta') {
                extraHTML = `<div id="atleta_opts_tm" style="display:${isChecked ? 'block' : 'none'}; margin-top:5px; padding:5px; border-left:2px solid var(--ink-red);">
                    <label style="font-size:0.9em; display:inline-block; margin-right:10px;"><input type="radio" name="atleta_bonus_tm" value="FUE" checked onchange="app.syncAtleta()"> +1 FUE</label>
                    <label style="font-size:0.9em; display:inline-block;"><input type="radio" name="atleta_bonus_tm" value="DES" onchange="app.syncAtleta()"> +1 DES</label>
                </div>`;
            }

            card.innerHTML = `
                <input type="checkbox" value="${t.name}" ${extraAttr} data-desc="${t.desc}" ${isChecked ? "checked" : ""} onchange="app.toggleTalent(this, '${t.name}', '${t.id || ''}')">
                <div class="talent-info">
                    <h4>${t.name}</h4>
                    <div class="talent-desc">${t.desc}</div>
                    ${extraHTML}
                </div>
            `;
            listContainer.appendChild(card);
        });
    },

    toggleTalent: function(checkbox, name, id) {
        let hiddenInput = document.querySelector(`input[name="chk_talents_hidden"][value="${name}"]`);
        const card = checkbox.closest('.talent-card');
        
        if (checkbox.checked) {
            const currentCount = document.querySelectorAll('input[name="chk_talents_hidden"]').length;
            if (currentCount >= 3) {
                alert("Solo puedes elegir 3 talentos.");
                checkbox.checked = false;
                return;
            }

            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'chk_talents_hidden';
                hiddenInput.value = name;
                hiddenInput.setAttribute('data-desc', checkbox.getAttribute('data-desc'));
                if(id) hiddenInput.setAttribute('data-id', id);
                document.body.appendChild(hiddenInput);
            }
            card.classList.add('selected');
            
            if (id === 'atleta') {
                const opts = document.getElementById('atleta_opts_tm');
                if(opts) opts.style.display = 'block';
            }

        } else {
            if (hiddenInput) hiddenInput.remove();
            card.classList.remove('selected');
            if (id === 'atleta') {
                const opts = document.getElementById('atleta_opts_tm');
                if(opts) opts.style.display = 'none';
            }
        }
        
        this.updateTalentCountDisplay();
        this.calc();
    },

    clearTalents: function() {
        if(!confirm("¬øBorrar todos los talentos seleccionados?")) return;
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(el => el.remove());
        
        const container = document.getElementById('tm_list');
        if(container) {
            container.querySelectorAll('input[type="checkbox"]').forEach(c => {
                c.checked = false;
                c.closest('.talent-card').classList.remove('selected');
            });
        }
        
        const atletaOpts = document.getElementById('atleta_opts_tm');
        if(atletaOpts) atletaOpts.style.display = 'none';
        
        this.updateTalentCountDisplay();
        this.calc();
    },

    updateTalentCountDisplay: function() {
        const count = document.querySelectorAll('input[name="chk_talents_hidden"]').length;
        document.getElementById('talent_count_main').innerText = count;
        document.getElementById('talent_count_modal').innerText = count;
    },

    showTalentSummary: function() {
        const checked = Array.from(document.querySelectorAll('input[name="chk_talents_hidden"]')); 
        const listDiv = document.getElementById('talents_summary_list'); 
        listDiv.innerHTML = "";
        
        if (checked.length > 0) {
            document.getElementById('talents_summary_view').style.display = 'block';
            checked.forEach(chk => { 
                const div = document.createElement('div'); 
                div.className = 'talent-final-item'; 
                div.innerHTML = `<strong>${chk.value}</strong>`; 
                listDiv.appendChild(div); 
            });
        } else {
            document.getElementById('talents_summary_view').style.display = 'none';
        }
    },

    syncAtleta: function() { this.calc(); },

    // ... (UI Helper Functions)
    autoResize: function(id) { const el = document.getElementById(id); el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; },
    
    fillSelect: function(id, data) { 
        const s = document.getElementById(id); 
        s.innerHTML = '<option value="" disabled selected>-- Seleccionar --</option>'; 
        for(let k in data) { let o = document.createElement('option'); o.value = k; o.innerText = data[k].name; s.appendChild(o); } 
    },
    
    startCrop: function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                app.cropState.img = new Image();
                app.cropState.img.onload = function() {
                    const containerW = 276; const containerH = 380;
                    const scaleW = containerW / app.cropState.img.naturalWidth;
                    const scaleH = containerH / app.cropState.img.naturalHeight;
                    const baseScale = Math.max(scaleW, scaleH);
                    app.cropState.zoom = baseScale;
                    app.cropState.x = (containerW - (app.cropState.img.naturalWidth * baseScale)) / 2;
                    app.cropState.y = (containerH - (app.cropState.img.naturalHeight * baseScale)) / 2;
                    const slider = document.getElementById('crop_zoom');
                    slider.min = baseScale * 0.1; slider.max = baseScale * 5; slider.step = 0.01;
                    slider.value = baseScale;
                    document.getElementById('crop_preview').src = app.cropState.img.src;
                    document.getElementById('crop_modal').showModal();
                    app.updateCropView();
                }
                app.cropState.img.src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
        input.value = ""; 
    },
    updateCropView: function() {
        const zoom = document.getElementById('crop_zoom').value;
        app.cropState.zoom = parseFloat(zoom);
        const img = document.getElementById('crop_preview');
        img.style.transform = `translate3d(${app.cropState.x}px, ${app.cropState.y}px, 0) scale(${app.cropState.zoom})`;
    },
    startDrag: function(e) {
        app.cropState.isDragging = true;
        app.cropState.lastX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        app.cropState.lastY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        e.preventDefault();
    },
    doDrag: function(e) {
        if (!app.cropState.isDragging) return;
        const cx = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const cy = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        const dx = cx - app.cropState.lastX;
        const dy = cy - app.cropState.lastY;
        app.cropState.x += dx; app.cropState.y += dy;
        app.cropState.lastX = cx; app.cropState.lastY = cy;
        app.updateCropView();
    },
    endDrag: function() { app.cropState.isDragging = false; },
    applyCrop: function() {
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        const containerW = 276; const containerH = 380;
        const targetW = containerW * 2; const targetH = containerH * 2;
        canvas.width = targetW; canvas.height = targetH;
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0,0,targetW, targetH);
        ctx.translate(app.cropState.x * 2, app.cropState.y * 2);
        ctx.scale(app.cropState.zoom * 2, app.cropState.zoom * 2);
        ctx.drawImage(app.cropState.img, 0, 0);
        document.getElementById('char_img').src = canvas.toDataURL('image/jpeg', 0.95);
        document.getElementById('crop_modal').close();
    },

    updateOptions: function(resetCheckboxes = false) {
        if (!this.DB.archetypes) return;
        const arqKey = document.getElementById('sel_arq').value; 
        const bgKey = document.getElementById('sel_bg').value; 
        const descKey = document.getElementById('sel_desc').value;
        
        const descData = this.DB.descriptors[descKey];
        const arqData = this.DB.archetypes[arqKey];
        const bgData = this.DB.backgrounds[bgKey];

        document.getElementById('desc_info').innerText = descData ? (descData.bonus + ". " + descData.txt) : "";
        document.getElementById('arq_info').innerText = arqData ? arqData.txt : ""; 
        document.getElementById('bg_info').innerText = bgData ? "Otorga 2 Habilidades y Kit." : "";
        
        const filoSelect = document.getElementById('sel_filo'); 
        const currentEdge = filoSelect.value; 
        filoSelect.innerHTML = '<option value="" disabled selected>-- Seleccionar --</option>';
        
        if (arqData && arqData.edges) {
            arqData.edges.forEach(edge => { let opt = document.createElement('option'); opt.value = edge; opt.innerText = edge; filoSelect.appendChild(opt); });
            if(arqData.edges.includes(currentEdge)) filoSelect.value = currentEdge;
        }
        
        this.renderCheckboxes('skills_arq', 'chk_arq', arqData ? arqData.skills : [], arqData ? arqData.limit : 0);
        this.renderCheckboxes('skills_bg', 'chk_bg', bgData ? bgData.skills : [], 2);
        document.getElementById('limit_arq').innerText = arqData ? arqData.limit : "0";
        this.calc();
    },
    
    renderCheckboxes: function(containerId, name, skills, limit) {
        const div = document.getElementById(containerId); div.innerHTML = "";
        skills.forEach(s => { const lbl = document.createElement('label'); lbl.className = 'skill-opt'; lbl.innerHTML = `<input type="checkbox" name="${name}" value="${s}" onchange="app.checkLimit('${name}', ${limit}); app.calc()"> ${s}`; div.appendChild(lbl); });
    },
    
    checkLimit: function(name, limit) { const checked = document.querySelectorAll(`input[name="${name}"]:checked`); if(checked.length > limit) { alert(`Solo puedes elegir ${limit}.`); event.target.checked = false; } },
    
    toggleSection: function(section, showEdit) { document.getElementById(`${section}_edit_view`).style.display = showEdit ? 'block' : 'none'; document.getElementById(`${section}_summary_view`).style.display = showEdit ? 'none' : 'block'; },
    
    getMod: function(val) { if(val <= 3) return -3; if(val <= 6) return -2; if(val <= 9) return -1; if(val <= 12) return 0; if(val <= 14) return 1; if(val <= 16) return 2; return 3; },

    calc: function() {
        if (!this.DB.descriptors) return;
        
        const stats = { FUE: parseInt(document.getElementById('base_FUE').value)||8, DES: parseInt(document.getElementById('base_DES').value)||8, CON: parseInt(document.getElementById('base_CON').value)||8, INT: parseInt(document.getElementById('base_INT').value)||8, SAB: parseInt(document.getElementById('base_SAB').value)||8, CAR: parseInt(document.getElementById('base_CAR').value)||8 };
        
        const descKey = document.getElementById('sel_desc').value;
        const descData = this.DB.descriptors ? this.DB.descriptors[descKey] : null;
        if (descData) {
            for(let k in descData.mods) stats[k] += descData.mods[k];
        }
        
        const atletaHidden = document.querySelector('input[name="chk_talents_hidden"][data-id="atleta"]');
        if(atletaHidden) {
            const bonus = document.querySelector('input[name="atleta_bonus_tm"]:checked')?.value || "FUE";
            stats[bonus] += 1;
        }

        let statHTML = "", summaryHTML = "";
        for(let k in stats) { 
            let mod = this.getMod(stats[k]); 
            let display = `${k}: <b>${stats[k]}</b> (${mod>=0?'+':''}${mod})`; 
            statHTML += `<div class="stat-box-dark">${display}</div>`; 
            summaryHTML += `<div class="stat-box">${display}</div>`; 
        }
        document.getElementById('stats_final_display').innerHTML = statHTML; 
        document.getElementById('stats_summary_text').innerHTML = summaryHTML;

        // Saves
        const profBonus = 2; const selCommon = document.querySelector('input[name="save_common"]:checked')?.value; const selUncommon = document.querySelector('input[name="save_uncommon"]:checked')?.value;
        let savesHTML = "", savesSummary = "";
        ["FUE", "DES", "CON", "INT", "SAB", "CAR"].forEach(stat => {
            let baseMod = this.getMod(stats[stat]); let isProf = (stat === selCommon || stat === selUncommon); let total = baseMod + (isProf ? profBonus : 0); let style = isProf ? "color:var(--ink-red); text-decoration:underline;" : "color:var(--ink-main);";
            savesHTML += `<div style="${style}"><div style="font-size:0.7em;">${stat}</div>${total>=0?'+':''}${total}</div>`;
            let summaryStyle = isProf ? "font-weight:bold; color:var(--ink-red);" : "";
            savesSummary += `<div class="stat-box" style="${summaryStyle}">${stat}: ${total>=0?'+':''}${total}</div>`;
        });
        document.getElementById('saves_display').innerHTML = savesHTML;
        document.getElementById('saves_summary_text').innerHTML = savesSummary;

        const skillCounts = {}; if(descData && descData.grant) descData.grant.forEach(s => skillCounts[s] = (skillCounts[s]||0) + 1);
        ['chk_arq', 'chk_bg'].forEach(grp => { document.querySelectorAll(`input[name="${grp}"]:checked`).forEach(chk => { skillCounts[chk.value] = (skillCounts[chk.value]||0) + 1; }); });
        const finalDiv = document.getElementById('final_skills_list'); finalDiv.innerHTML = "";
        for(let s in skillCounts) { let grade = skillCounts[s] >= 2 ? 1 : 0; let tag = document.createElement('span'); tag.className = `skill-tag ${grade===1 ? 'grade-1' : ''}`; tag.innerText = `${s} [G${grade}]`; finalDiv.appendChild(tag); }

        const arqKey = document.getElementById('sel_arq').value; 
        const arqData = this.DB.archetypes ? this.DB.archetypes[arqKey] : null;
        
        const bgKey = document.getElementById('sel_bg').value; 
        const bgData = this.DB.backgrounds ? this.DB.backgrounds[bgKey] : null;
        
        const descName = descData ? descData.name : "---"; 
        const arqName = arqData ? arqData.name : "---"; 
        const bgName = bgData ? bgData.name : "---";
        document.getElementById('identity_summary_text').innerHTML = `<b>${descName}</b> | <b>${arqName}</b> | <b>${bgName}</b>`;

        if (!arqData) return; 
        
        const armKey = document.getElementById('sel_armor').value;
        const armor = (this.DB.armors && this.DB.armors[armKey]) || { name:"-", ca:10, type:"none", slots:0 };
        
        const wepKey = document.getElementById('sel_weapon').value;
        const weapon = (this.DB.weapons && this.DB.weapons[wepKey]) || { name:"-", dmg:"-", stat:"FUE", slots:0, cat:"simple", prop:"", req:0 };
        
        const shieldKey = document.getElementById('sel_shield').value;
        const shield = (this.DB.shields && this.DB.shields[shieldKey]) || { name:"", bonus:0, slots:0 };
        
        const pv = arqData.pv + stats.CON; const flesh = stats.CON;
        
        let bonusIng = 0;
        let bonusIni = 0;
        
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(input => {
            const id = input.getAttribute('data-id');
            const name = input.value;
            // Doble comprobaci√≥n: ID o Nombre por si acaso
            if (id === 'despertar' || name === "Despertar Sobrenatural") bonusIng = 6;
            if (id === 'alerta') bonusIni = 5;
        });
        
        const maxFis = Math.max(stats.FUE, stats.DES); 
        const maxMen = Math.max(stats.INT, stats.SAB, stats.CAR); 
        
        // RESERVAS CORREGIDAS: STAT + NIVEL (1) + BONO CLASE + TALENTOS
        const adr = maxFis + 1 + arqData.adr; 
        const ing = maxMen + 1 + arqData.ing + bonusIng; 
        
        let modDes = this.getMod(stats.DES); let ca = armor.ca; 
        let defNatural = document.querySelector('input[name="chk_talents_hidden"][data-id="def_nat"]');
        if (armor.type === 'none' && defNatural) { ca = 10 + modDes + this.getMod(stats.CON); } else { if (armor.type === 'light' || armor.type === 'none') ca += modDes; if (armor.type === 'medium') ca += Math.min(modDes, 2); }
        ca += shield.bonus; ca += arqData.ca; if(document.getElementById('chk_magic_ac').checked) ca += 1;

        let atkStatVal = stats.FUE; if (weapon.stat === 'DES') atkStatVal = stats.DES; if (weapon.stat === 'FIN') atkStatVal = Math.max(stats.FUE, stats.DES);
        let attrMod = this.getMod(atkStatVal); let isProf = false; let meetsReq = (weapon.req === 0) || (stats.FUE >= weapon.req || stats.DES >= weapon.req); 
        if (arqKey === "valor") { isProf = true; meetsReq = true; } else if (arqKey === "gracia") { if (weapon.cat === "simple" || weapon.prop === "sutil") { isProf = true; if (weapon.prop === "sutil") meetsReq = true; } } else { if (weapon.cat === "simple") isProf = true; }
        let totalAtk = attrMod + (isProf ? 2 : 0); if(!meetsReq && isProf) totalAtk -= 2;
        let magicAtkMod = Math.max(this.getMod(stats.INT), this.getMod(stats.SAB), this.getMod(stats.CAR)) + 2;
        let dmgAttr = stats.FUE; if (weapon.stat === 'DES') dmgAttr = stats.DES; if (weapon.stat === 'FIN') dmgAttr = Math.max(stats.FUE, stats.DES);
        let dmgMod = this.getMod(dmgAttr); let dmgSign = dmgMod > 0 ? "+" + dmgMod : ""; let finalDmg = `${weapon.dmg} ${dmgSign}`;
        const cargaTotal = armor.slots + weapon.slots + shield.slots; const cargaMax = stats.FUE;

        document.getElementById('armor_info').innerText = `Tipo: ${armor.type.toUpperCase()} | Slots: ${armor.slots}`;
        const combatString = `Ataque: <span style="color:var(--ink-red); font-weight:bold;">${totalAtk >= 0 ? '+' : ''}${totalAtk}</span> | Da√±o: ${finalDmg}`;
        document.getElementById('weapon_info').innerHTML = combatString; document.getElementById('prof_alert').innerText = !meetsReq ? "‚ö†Ô∏è Faltan requisitos" : "";
        document.getElementById('combat_summary_text').innerHTML = `<b>${armor.name}</b><br><b>${weapon.name}</b> + <b>${shield.name}</b>`; document.getElementById('combat_summary_stats').innerHTML = combatString;

        document.getElementById('res_pv').innerText = pv; document.getElementById('res_carne').innerText = flesh;
        document.getElementById('res_carga').innerText = cargaTotal + " / " + cargaMax; document.getElementById('res_carga').style.color = cargaTotal > cargaMax ? "var(--ink-red)" : "var(--ink-main)";
        document.getElementById('res_adr').innerText = adr; document.getElementById('res_ing').innerText = ing;
        document.getElementById('res_ca').innerText = ca; document.getElementById('res_ini').innerText = (modDes + bonusIni >= 0 ? "+" : "") + (modDes + bonusIni);
        document.getElementById('res_atq_mag').innerText = (magicAtkMod >= 0 ? "+" : "") + magicAtkMod; document.getElementById('res_filo_val').innerText = document.getElementById('sel_filo').value;
    },

    randomize: function() {
        if (!this.DB.descriptors) return;
        ['base_FUE','base_DES','base_CON','base_INT','base_SAB','base_CAR'].forEach(id => { document.getElementById(id).value = Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+3; });
        
        const getRandomKey = (obj) => { const keys = Object.keys(obj); return keys[Math.floor(Math.random() * keys.length)]; };
        
        document.getElementById('sel_desc').value = getRandomKey(this.DB.descriptors);
        document.getElementById('sel_arq').value = getRandomKey(this.DB.archetypes);
        document.getElementById('sel_bg').value = getRandomKey(this.DB.backgrounds);
        document.getElementById('sel_shield').value = getRandomKey(this.DB.shields);
        
        const arq = document.getElementById('sel_arq').value;
        const armKeys = Object.keys(this.DB.armors);
        document.getElementById('sel_armor').value = armKeys[Math.floor(Math.random() * armKeys.length)];
        const wepKeys = Object.keys(this.DB.weapons);
        document.getElementById('sel_weapon').value = wepKeys[Math.floor(Math.random() * wepKeys.length)];
        
        this.updateOptions(true); 
        const filoSelect = document.getElementById('sel_filo');
        if(filoSelect.options.length > 1) filoSelect.selectedIndex = Math.floor(Math.random() * (filoSelect.options.length - 1)) + 1;

        const randRadio = (name) => { const r = Array.from(document.querySelectorAll(`input[name="${name}"]`)); r.forEach(x=>x.checked=false); r[Math.floor(Math.random()*r.length)].checked=true; };
        randRadio('save_common'); randRadio('save_uncommon');
        
        const randChecks = (name, limit) => { const b = Array.from(document.querySelectorAll(`input[name="${name}"]`)); b.forEach(x=>x.checked=false); b.sort(()=>Math.random()-0.5); b.slice(0,limit).forEach(x=>x.checked=true); };
        const arqLimit = this.DB.archetypes[document.getElementById('sel_arq').value].limit;
        randChecks('chk_arq', arqLimit); randChecks('chk_bg', 2); 
        
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(el => el.remove());
        const allTalents = [];
        Object.values(this.DB.talents).forEach(arr => arr.forEach(t => allTalents.push(t)));
        allTalents.sort(() => Math.random() - 0.5).slice(0,3).forEach(t => {
            const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = 'chk_talents_hidden'; hidden.value = t.name; 
            if(t.id) hidden.setAttribute('data-id', t.id);
            document.body.appendChild(hidden);
        });
        
        this.updateTalentCountDisplay(); // FIX: Update count on random
        this.showTalentSummary();
        ['skills', 'stats', 'identity', 'saves', 'combat'].forEach(s => this.toggleSection(s, false));
        this.calc();
    },

    clear: function() {
        ['base_FUE','base_DES','base_CON','base_INT','base_SAB','base_CAR'].forEach(id => { document.getElementById(id).value = 8; });
        document.getElementById('char_name').value = ""; document.getElementById('char_concept').value = "";
        
        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        
        const checks = document.querySelectorAll('input[type="checkbox"], input[type="radio"]'); checks.forEach(c => c.checked = false);
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(el => el.remove());
        document.getElementById('char_img').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='%234a3b2a'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E";
        
        this.autoResize('char_concept'); 
        this.showTalentSummary();
        this.updateTalentCountDisplay();
        ['skills', 'stats', 'identity', 'saves', 'combat'].forEach(s => this.toggleSection(s, true));
        this.updateOptions(true); 
    },

    saveChar: function() {
        const charName = document.getElementById('char_name').value.trim(); if (!charName) { alert("¬°Tu h√©roe necesita un nombre!"); return; }
        let roster = JSON.parse(localStorage.getItem('sands_roster') || "{}"); if (roster[charName] && !confirm(`¬øSobrescribir a "${charName}"?`)) return;
        const saveData = this.gatherCharData();
        roster[charName] = saveData; 
        try { localStorage.setItem('sands_roster', JSON.stringify(roster)); alert(`Guardado en Navegador: ${charName}`); } catch (e) { alert("¬°Memoria llena!"); }
    },
    openLoadMenu: function() {
        const roster = JSON.parse(localStorage.getItem('sands_roster') || "{}"); const listDiv = document.getElementById('char_list'); listDiv.innerHTML = "";
        Object.keys(roster).forEach(name => { 
            const row = document.createElement('div'); row.className = 'char-row'; 
            row.innerHTML = `
                <span class="char-info" style="font-weight:bold; font-family:var(--font-title); font-size:1.2em;">${name}</span>
                <div class="char-actions">
                    <button class="btn-mini btn-load" onclick="app.loadSpecificChar('${name}')">üìÇ Cargar</button>
                    <button class="btn-mini btn-del" onclick="app.deleteChar('${name}')">‚úñ Borrar</button>
                </div>`; 
            listDiv.appendChild(row); 
        });
        document.getElementById('char_manager').showModal();
    },
    loadSpecificChar: function(name) {
        const roster = JSON.parse(localStorage.getItem('sands_roster') || "{}"); const data = roster[name]; if (!data) return;
        this.applyCharData(data); document.getElementById('char_manager').close();
    },
    deleteChar: function(name) { if(confirm(`¬øBorrar a "${name}"?`)) { let roster = JSON.parse(localStorage.getItem('sands_roster') || "{}"); delete roster[name]; localStorage.setItem('sands_roster', JSON.stringify(roster)); this.openLoadMenu(); } },

    gatherCharData: function() {
        const data = { inputs: {}, selects: {}, checks: [], hidden_talents: [], portrait: document.getElementById('char_img').src, concept: document.getElementById('char_concept').value };
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => data.inputs[el.id] = el.value);
        document.querySelectorAll('select').forEach(el => data.selects[el.id] = el.value);
        document.querySelectorAll('input[type="checkbox"]:not([type="hidden"]):checked, input[type="radio"]:not([name="atleta_bonus_tm"]):checked').forEach(el => { data.checks.push({ name: el.name, value: el.value, id: el.id }); });
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(el => data.hidden_talents.push({value: el.value, id: el.getAttribute('data-id')}));
        return data;
    },
    applyCharData: function(data) {
        for (let id in data.inputs) { const el = document.getElementById(id); if (el) el.value = data.inputs[id]; }
        for (let id in data.selects) { const el = document.getElementById(id); if (el) el.value = data.selects[id]; }
        if (data.portrait) document.getElementById('char_img').src = data.portrait; 
        if (data.concept) document.getElementById('char_concept').value = data.concept;
        
        this.updateOptions(false);

        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="chk_talents_hidden"]').forEach(el => el.remove());

        if(data.checks) data.checks.forEach(item => { let el = document.getElementById(item.id); if (!el) el = document.querySelector(`input[name="${item.name}"][value="${item.value}"]`); if (el) el.checked = true; });
        if(data.hidden_talents) data.hidden_talents.forEach(t => {
            const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = 'chk_talents_hidden'; hidden.value = t.value; 
            if(t.id) hidden.setAttribute('data-id', t.id);
            document.body.appendChild(hidden);
        });

        this.autoResize('char_concept'); 
        this.showTalentSummary(); 
        this.updateTalentCountDisplay();
        ['skills', 'stats', 'identity', 'saves', 'combat'].forEach(s => this.toggleSection(s, false));
        this.calc();
    },
    exportJSON: function() {
        const charName = document.getElementById('char_name').value.trim() || "aventurero";
        const data = this.gatherCharData();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute("href", dataStr);
        downloadAnchor.setAttribute("download", charName.replace(/ /g, "_") + ".json");
        document.body.appendChild(downloadAnchor); downloadAnchor.click(); downloadAnchor.remove();
    },
    triggerLoadJSON: function() { document.getElementById('json_char_input').click(); },
    loadJSON: function(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) { try { app.applyCharData(JSON.parse(e.target.result)); alert("Personaje importado."); } catch(err) { alert("Error al leer JSON."); } };
        reader.readAsText(input.files[0]); input.value = "";
    }
};

window.onload = function() { app.init(); };

// PWA
let deferredPrompt; window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const btnInstall = document.getElementById('btn-install'); if(btnInstall) { btnInstall.style.display = 'block'; btnInstall.addEventListener('click', () => { btnInstall.style.display = 'none'; deferredPrompt.prompt(); deferredPrompt = null; }); } });
</script>

</body>
</html>
